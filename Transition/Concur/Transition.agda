-- The "residual" of a concurrent pair after a third concurrent transition. To define this for โฃ rather than โฃโ will
-- need to first show that โฃ is a congruence. If I set up โฃ so it is a congruence by definition (with a symmetric
-- variant of each rule), then the definition of this residual is huge and Agda runs out of memory compiling it.
module Transition.Concur.Transition where

   open import SharedModules

   open import Action as แดฌ using (Action); open แดฌ.Action; open แดฌ.Actionแต
   open import Action.Concur using (_แดฌโฃ_; module _แดฌโฃ_; แดฌโฃ-sym; แดฌโ); open _แดฌโฃ_
   open import Action.Concur.Action using (/-preserves-แดฌโฃ)
   open import Name using (zero)
   open import Proc as แดพ using (Proc)
   open import Ren as แดฟ using (Ren; push; pop; swap); open แดฟ.Renameable โฆ...โฆ
   open import Ren.Properties
   open import Transition as แต using (_โ[_-_]โ_); open แต._โ[_-_]โ_
   open import Transition.Ren using (_*แต; _*แถ)
   open import Transition.Concur
      using (Concurโ; module Concurโ; Concur; Deltaโฒ; module Deltaโฒ; Delta; โ; โโ; โฃ-sym);
      open Concurโ; open Deltaโฒ
   open import Transition.Concur.Cofinal using (โ-โ)
   open import Transition.Concur.Cofinal.Transition using (โโฒ[_,_]; module _ฮโฒ_)
   open import Transition.Concur.Ren using (_*แตแตโฃ; _*แตแถโฃ; _*แถแตโฃ; _*แถแถโฃ)

   -- A "cyclic" version is probably more useful. However for the asymmetric version of the relation, ๐ธโณ
   -- would be mostly uninhabited. TODO: ๐ธ/E and E/๐ธ notation, once I've improved overloading situation.
   postulate
      /-preserves-โฃ : โ {ฮ} {P : Proc ฮ} {a aโฒ aโณ R Rโฒ Rโณ} {๐ : a แดฌโฃ aโฒ} {๐โฒ : aโฒ แดฌโฃ aโณ} {๐โณ : aโณ แดฌโฃ a}
                      {E : P โ[ a - _ ]โ R} {Eโฒ : P โ[ aโฒ - _ ]โ Rโฒ} {Eโณ : P โ[ aโณ - _ ]โ Rโณ} โ
                      (๐ธ : E โฃ[ ๐ ] Eโฒ) โ Eโฒ โฃ[ ๐โฒ ] Eโณ โ (๐ธโณ : Eโณ โฃ[ ๐โณ ] E) โ
                      Eโฒ/E (โ ๐ธ) โฃ[ /-preserves-แดฌโฃ ๐ ๐โฒ (แดฌโฃ-sym ๐โณ) ] E/Eโฒ (โ ๐ธโณ)

      -- This would be the correctness property for E\๐ธ, I think.
      /-preserves-cofin :
         โ {ฮ} {P : Proc ฮ} {a aโฒ aโณ R Rโฒ Rโณ} {๐ : a แดฌโฃ aโฒ} {๐โฒ : aโฒ แดฌโฃ aโณ} {๐โณ : aโณ แดฌโฃ a}
         {E : P โ[ a - _ ]โ R} {Eโฒ : P โ[ aโฒ - _ ]โ Rโฒ} {Eโณ : P โ[ aโณ - _ ]โ Rโณ} โ
         (๐ธ : E โฃ[ ๐ ] Eโฒ) (๐ธโฒ : Eโฒ โฃ[ ๐โฒ ] Eโณ) (๐ธโณ : Eโณ โฃ[ ๐โณ ] E) โ
         let ๐ธโฒ/E = /-preserves-โฃ ๐ธ ๐ธโฒ ๐ธโณ; ๐ธ/Eโณ = /-preserves-โฃ ๐ธโณ ๐ธ ๐ธโฒ; open _ฮโฒ_
         in E/Eโฒ (โ ๐ธโฒ/E) โ E/ฮณ (โโฒ[ (aโณ , ฯโ (แดฌโ ๐โณ)) , zero ] (Eโฒ/E (โ ๐ธ/Eโณ)) (โ-โ ๐ธโณ))

   -- The residual ๐ธโฒ/E. Slight case-explosion because of need to distinguish the แตโแต and แตโแต cases pairwise.
   /-preserves-โฃโ : โ {ฮ} {P : Proc ฮ} {a aโฒ aโณ R Rโฒ Rโณ} {๐ : a แดฌโฃ aโฒ} {๐โฒ : aโฒ แดฌโฃ aโณ} {๐โณ : a แดฌโฃ aโณ}
                   {E : P โ[ a - _ ]โ R} {Eโฒ : P โ[ aโฒ - _ ]โ Rโฒ} {Eโณ : P โ[ aโณ - _ ]โ Rโณ} โ
                   (๐ธ : E โฃโ[ ๐ ] Eโฒ) โ Eโฒ โฃโ[ ๐โฒ ] Eโณ โ (๐ธโณ : E โฃโ[ ๐โณ ] Eโณ) โ
                   Eโฒ/E (โโ ๐ธ) โฃโ[ /-preserves-แดฌโฃ ๐ ๐โฒ ๐โณ ] Eโฒ/E (โโ ๐ธโณ)
   /-preserves-โฃโ (๐ธ โแตฅโข ๐น) (๐ธโฒ โโข ๐นโฒ) (๐ธโณ โแตฅโข ๐นโณ) = ฮฝแถแถ (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ)
   /-preserves-โฃโ (_โแตฅโข_ {y = y} ๐ธ ๐น) (๐ธโฒ โโขแตฅ ๐นโฒ) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธโณ ๐นโณ) with (pop y *แต) (E/Eโฒ (โโ ๐ธ))
   ... | pop-y*E/Eโฒ = ฮฝแถแถ (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโขแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ)
   /-preserves-โฃโ (_โแตฅโข_ {y = y} ๐ธ ๐น) (๐ธโฒ โโขแตฅ ๐นโฒ) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธโณ ๐นโณ) with (pop y *แต) (E/Eโฒ (โโ ๐ธ))
   ... | pop-y*E/Eโฒ = ฮฝแถแถ (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ)

   /-preserves-โฃโ (_โโขแตฅ_ {y = y} ๐ธ ๐น) (๐ธโฒ โแตฅโข ๐นโฒ) (๐ธโณ โโข ๐นโณ) with (pop y *แต) (E/Eโฒ (โโ ๐ธ))
   ... | pop-y*E/Eโฒ = ((pop y) *แตแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ) โแตฅโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (๐ธ โโขแตฅ ๐น) (๐ธโฒ โแตฅ ๐นโฒ) (๐ธโณ โโขแตฅ ๐นโณ) = (pop _ *แตแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ) โแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ

   /-preserves-โฃโ (_โแตฅแต_ {a = a} ๐ธ F) (_โแตฅโข_ {y = y} ๐ธโฒ ๐นโฒ) (๐ธโณ โโขแต Fโฒ) with (pop y *แต) (E/Eโฒ (โโ ๐ธโณ))
   ... | pop-y*E/Eโณ rewrite popโpush y a = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โแตฅโข (push *แตแถโฃ) ๐นโฒ
   /-preserves-โฃโ (๐ธ โแตฅแต F) (๐ธโฒ โแตฅ ๐น) (๐ธโณ โแตฅแต Fโฒ) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โแตฅ (push *แตแตโฃ) ๐น

   /-preserves-โฃโ (_โแตฅแถ_ {a = a} ๐ธ F) (_โแตฅโข_ {y = y} ๐ธโฒ ๐นโฒ) (๐ธโณ โโขแถ Fโฒ) with (pop y *แถ) (E/Eโฒ (โโ ๐ธโณ))
   ... | pop-y*E/Eโณ rewrite popโpush y a = (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ) โแตฅโข ๐นโฒ
   /-preserves-โฃโ (๐ธ โแตฅแถ F) (๐ธโฒ โแตฅ ๐นโฒ) (๐ธโณ โแตฅแถ Fโฒ) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โแตฅ ๐นโฒ

   /-preserves-โฃโ (_แตโแตฅ_ {๐ = แตโแต} E ๐น) (๐ธโฒ โแตฅโข ๐นโฒ) (Eโฒ แตโโข ๐นโณ) = (push *แตแตโฃ) ๐ธโฒ โแตฅโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (_แตโแตฅ_ {๐ = แตโแต} E ๐น) (๐ธโฒ โแตฅโข ๐นโฒ) (Eโฒ แตโโข ๐นโณ) = (push *แตแตโฃ) ๐ธโฒ โโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (_แตโแตฅ_ {๐ = แตโแต} E ๐น) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} Eโฒ ๐นโณ) =
      (push *แตแตโฃ) ๐ธ โแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (_แตโแตฅ_ {๐ = แตโแต} E ๐น) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} Eโฒ ๐นโณ) =
      (push *แตแตโฃ) ๐ธ โแตฅโข (/-preserves-โฃโ ๐น ๐นโฒ ๐นโณ)
   /-preserves-โฃโ (_แตโแตฅ_ {๐ = แตโแต} E ๐น) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} Eโฒ ๐นโณ) =
      (push *แตแตโฃ) ๐ธ โแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (_แตโแตฅ_ {๐ = แตโแต} E ๐น) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} Eโฒ ๐นโณ) =
      (push *แตแตโฃ) ๐ธ โแตฅโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (_แตโแตฅ_ {๐ = แตโแต} E ๐น) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} Eโฒ ๐นโณ) =
      (push *แตแตโฃ) ๐ธ โโขแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (_แตโแตฅ_ {๐ = แตโแต} E ๐น) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} Eโฒ ๐นโณ) =
      (push *แตแตโฃ) ๐ธ โโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (_แตโแตฅ_ {๐ = แตโแต} E ๐น) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} Eโฒ ๐นโณ) =
      (push *แตแตโฃ) ๐ธ โโขแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (_แตโแตฅ_ {๐ = แตโแต} E ๐น) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} Eโฒ ๐นโณ) =
      (push *แตแตโฃ) ๐ธ โโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ

   /-preserves-โฃโ (E แถโแตฅ ๐น) (๐ธ โแตฅโข ๐นโฒ) (Eโฒ แถโโข ๐นโณ) = ๐ธ โแตฅโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (E แถโแตฅ ๐น) (๐ธโฒ โแตฅ ๐นโฒ) (Eโฒ แถโแตฅ ๐นโณ) = ๐ธโฒ โแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ

   /-preserves-โฃโ (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐น) (_โแตฅโข_ {y = y} ๐ธโฒ ๐นโฒ) (๐ธโณ โแตฅโข ๐นโณ) with (pop y *แต) (E/Eโฒ (โโ ๐ธโฒ))
   ... | pop-y*Eโฒ/Eโณ = ฮฝแถแถ (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โแตฅโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ)
   /-preserves-โฃโ (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐น) (_โแตฅโข_ {y = y} ๐ธโฒ ๐นโฒ) (๐ธโณ โแตฅโข ๐นโณ) with (pop y *แต) (E/Eโฒ (โโ ๐ธโฒ))
   ... | pop-y*Eโฒ/Eโณ = ฮฝแถแถ (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ)
   /-preserves-โฃโ (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐น) (๐ธโฒ โแตฅ ๐นโฒ) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธโณ ๐นโณ) =
      ฮฝแถแถ (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ)
   /-preserves-โฃโ (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐น) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธโฒ ๐นโฒ) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธโณ ๐นโณ) =
      ฮฝแถแถ (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โแตฅโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ)
   /-preserves-โฃโ (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐น) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธโฒ ๐นโฒ) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธโณ ๐นโณ) =
      ฮฝแถแถ (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโขแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ)
   /-preserves-โฃโ (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐น) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธโฒ ๐นโฒ) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธโณ ๐นโณ) =
      ฮฝแถแถ (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โแตฅโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ)
   /-preserves-โฃโ (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐น) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธโฒ ๐นโฒ) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธโณ ๐นโณ) =
      ฮฝแถแถ (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ)
   /-preserves-โฃโ (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐น) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธโฒ ๐นโฒ) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธโณ ๐นโณ) =
      ฮฝแถแถ (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโขแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ)
   /-preserves-โฃโ (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐น) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธโฒ ๐นโฒ) (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธโณ ๐นโณ) =
      ฮฝแถแถ (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ)

   /-preserves-โฃโ (๐ธ แถแตโ Q) (Eโฒ แตโแต F) (E แถโแต .F) = Eโฒ/E (โโ ๐ธ) แตโแต F
   /-preserves-โฃโ (๐ธ แถแตโ Q) (Eโฒ แตโแถ F) (E แถโแถ .F) = Eโฒ/E (โโ ๐ธ) แตโแถ F
   /-preserves-โฃโ (๐ธ แถแตโ Q) (๐ธโฒ โโขแต F) (_โโขแถ_ {y = y} {a = a} ๐ธโณ .F) with (pop y *แถ) (E/Eโฒ (โโ ๐ธโณ))
   ... | pop-y*E/Eโณ rewrite popโpush y a = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโขแต F
   /-preserves-โฃโ (๐ธ แถแตโ Q) (๐ธโฒ โแตฅแต F) (๐ธโณ โแตฅแถ .F) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โแตฅแต F
   /-preserves-โฃโ (๐ธ แถแตโ Q) (๐ธโฒ แตแตโ .Q) (๐ธโณ แถแตโ .Q) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แตแตโ Q
   /-preserves-โฃโ (๐ธ แถแตโ Q) (๐ธโฒ แตแถโ .Q) (๐ธโณ แถแถโ .Q) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แตแถโ Q

   /-preserves-โฃโ (P โแถแต ๐น) (E แตโโข ๐นโฒ) (.E แถโโข ๐นโณ) = E แตโโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (P โแถแต ๐น) (E แตโแตฅ ๐นโฒ) (.E แถโแตฅ ๐นโณ) = E แตโแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (P โแถแต ๐น) (.P โแตแต ๐นโฒ) (.P โแถแต ๐นโณ) = P โแตแต /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (P โแถแต ๐น) (.P โแตแถ ๐นโฒ) (.P โแถแถ ๐นโณ) = P โแตแถ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ

   /-preserves-โฃโ (๐ธ แตแถโ Q) (๐ธโฒ แถแตโ .Q) (_แตแตโ_ {๐ = แตโแต} ๐ธโณ .Q) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แถแตโ (push *) Q
   /-preserves-โฃโ (๐ธ แตแถโ Q) (๐ธโฒ แถแตโ .Q) (_แตแตโ_ {๐ = แตโแต} ๐ธโณ .Q) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แถแถโ (push *) Q
   /-preserves-โฃโ (๐ธ แตแถโ Q) (E แถโแต F) (Eโฒ แตโแต .F) = Eโฒ/E (โโ ๐ธ) แถโแต (push *แต) F
   /-preserves-โฃโ (๐ธ แตแถโ Q) (E แถโแถ F) (Eโฒ แตโแถ .F) = Eโฒ/E (โโ ๐ธ) แถโแถ (push *แถ) F
   /-preserves-โฃโ (๐ธ แตแถโ Q) (๐ธโฒ โแตฅแถ F) (๐ธโณ โแตฅแต .F) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โแตฅแถ (push *แต) F
   /-preserves-โฃโ (๐ธ แตแถโ Q) (๐ธโฒ โโขแถ F) (_โโขแต_ {y = y} {a = a} ๐ธโณ .F) with (pop y *แต) (E/Eโฒ (โโ ๐ธโณ))
   ... | pop-y*E/Eโณ rewrite popโpush y a = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโขแถ (push *แถ) F
   /-preserves-โฃโ (๐ธ แตแถโ Q) (๐ธโฒ แถแถโ .Q) (๐ธโณ แตแถโ .Q) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แถแถโ (push *) Q

   /-preserves-โฃโ (P โแตแถ ๐น) (.P โแถแต ๐นโฒ) (_โแตแต_ {๐ = แตโแต} .P ๐นโณ) = (push *) P โแถแต /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (P โแตแถ ๐น) (.P โแถแต ๐นโฒ) (_โแตแต_ {๐ = แตโแต} .P ๐นโณ) = (push *) P โแถแถ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (P โแตแถ ๐น) (E แถโโข ๐นโฒ) (.E แตโโข ๐นโณ) = (push *แต) E แถโโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (P โแตแถ ๐น) (E แถโแตฅ ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} .E ๐นโณ) = (push *แต) E แถโแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (P โแตแถ ๐น) (E แถโแตฅ ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} .E ๐นโณ) = (push *แต) E แถโโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (P โแตแถ ๐น) (.P โแถแถ ๐นโฒ) (.P โแตแถ ๐นโณ) = (push *) P โแถแถ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ

   /-preserves-โฃโ (๐ธ แถแถโ Q) (๐ธโฒ แถแตโ .Q) (๐ธโณ แถแตโ .Q) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แถแตโ Q
   /-preserves-โฃโ (๐ธ แถแถโ Q) (E แถโแต F) (Eโฒ แถโแต .F) = Eโฒ/E (โโ ๐ธ) แถโแต F
   /-preserves-โฃโ (๐ธ แถแถโ Q) (E แถโแถ F) (Eโฒ แถโแถ .F) = Eโฒ/E (โโ ๐ธ) แถโแถ F
   /-preserves-โฃโ (๐ธ แถแถโ Q) (๐ธโฒ โโขแถ F) (_โโขแถ_ {y = y} {a = a} ๐ธโณ .F) with (pop y *แถ) (E/Eโฒ (โโ ๐ธโณ))
   ... | pop-y*E/Eโณ rewrite popโpush y a = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโขแถ F
   /-preserves-โฃโ (๐ธ แถแถโ Q) (๐ธโฒ โแตฅแถ F) (๐ธโณ โแตฅแถ .F) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โแตฅแถ F
   /-preserves-โฃโ (๐ธ แถแถโ Q) (๐ธโฒ แถแถโ .Q) (๐ธโณ แถแถโ .Q) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แถแถโ Q

   /-preserves-โฃโ (P โแถแถ ๐น) (.P โแถแต ๐นโฒ) (.P โแถแต ๐นโณ) = P โแถแต /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (P โแถแถ ๐น) (E แถโโข ๐นโฒ) (.E แถโโข ๐นโณ) = _ แถโโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (P โแถแถ ๐น) (E แถโแตฅ ๐นโฒ) (.E แถโแตฅ ๐นโณ) = E แถโแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (P โแถแถ ๐น) (.P โแถแถ ๐นโฒ) (.P โแถแถ ๐นโณ) = P โแถแถ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ

   /-preserves-โฃโ (E แตโแต F) (Eโฒ แตโโข ๐นโฒ) (_โโขแต_ {y = y} {a = a} ๐ธ Fโฒ) with (pop y *แต) (E/Eโฒ (โโ ๐ธ))
   ... | pop-y*E/Eโฒ rewrite popโpush y a = Eโฒ/E (โโ ๐ธ) แตโโข (push *แตแถโฃ) ๐นโฒ
   /-preserves-โฃโ (E แตโแต F) (Eโฒ แตโแตฅ ๐น) (๐ธ โแตฅแต Fโฒ) = Eโฒ/E (โโ ๐ธ) แตโแตฅ (push *แตแตโฃ) ๐น
   /-preserves-โฃโ {๐โฒ = แตโแต} (E แตโแต F) (P โแตแต ๐น) (.E แตโแต Fโฒ) = _ โแตแต (push *แตแตโฃ) ๐น
   /-preserves-โฃโ {๐โฒ = แตโแต} (E แตโแต F) (P โแตแต ๐น) (.E แตโแต Fโฒ) = _ โแตแต (push *แตแตโฃ) ๐น
   /-preserves-โฃโ (E แตโแต F) (P โแตแถ ๐น) (.E แตโแถ Fโฒ) = _ โแตแถ (push *แตแถโฃ) ๐น

   /-preserves-โฃโ (E แตโแถ F) (P โแถแต ๐น) (.E แตโแต Fโฒ) = _ โแถแต (push *แถแตโฃ) ๐น
   /-preserves-โฃโ (E แตโแถ F) (Eโฒ แถโโข ๐นโฒ) (_โโขแต_ {y = y} {a = a} ๐ธ Fโฒ) with (pop y *แต) (E/Eโฒ (โโ ๐ธ))
   ... | pop-y*E/Eโฒ rewrite popโpush y a = Eโฒ/E (โโ ๐ธ) แถโโข (push *แถแถโฃ) ๐นโฒ
   /-preserves-โฃโ (E แตโแถ F) (Eโฒ แถโแตฅ ๐น) (๐ธ โแตฅแต Fโฒ) = Eโฒ/E (โโ ๐ธ) แถโแตฅ (push *แถแตโฃ) ๐น
   /-preserves-โฃโ (E แตโแถ F) (P โแถแถ ๐น) (.E แตโแถ Fโฒ) = _ โแถแถ (push *แถแถโฃ) ๐น

   /-preserves-โฃโ (E แถโแต F) (Eโฒ แตโโข ๐นโฒ) (_โโขแถ_ {y = y} {a = a} ๐ธโณ Fโฒ) with (pop y *แถ) (E/Eโฒ (โโ ๐ธโณ))
   ... | pop-y*E/Eโณ rewrite popโpush y a = Eโฒ/E (โโ ๐ธโณ) แตโโข ๐นโฒ
   /-preserves-โฃโ (E แถโแต F) (Eโฒ แตโแตฅ ๐น) (๐ธ โแตฅแถ Fโฒ) = Eโฒ/E (โโ ๐ธ) แตโแตฅ ๐น
   /-preserves-โฃโ {๐โฒ = แตโแต} (E แถโแต F) (P โแตแต ๐น) (.E แถโแต Fโฒ) = _ โแตแต ๐น
   /-preserves-โฃโ {๐โฒ = แตโแต} (E แถโแต F) (P โแตแต ๐น) (.E แถโแต Fโฒ) = _ โแตแต ๐น
   /-preserves-โฃโ (E แถโแต F) (P โแตแถ ๐นโฒ) (.E แถโแถ Fโฒ) = _ โแตแถ ๐นโฒ

   /-preserves-โฃโ (E แถโแถ F) (P โแถแต ๐น) (.E แถโแต Fโฒ) = _ โแถแต ๐น
   /-preserves-โฃโ (E แถโแถ F) (Eโฒ แถโโข ๐น) (_โโขแถ_ {y = y} {a = a} ๐ธ Fโฒ) with (pop y *แถ) (E/Eโฒ (โโ ๐ธ))
   ... | pop-y*E/Eโฒ rewrite popโpush y a = Eโฒ/E (โโ ๐ธ) แถโโข ๐น
   /-preserves-โฃโ (E แถโแถ F) (Eโฒ แถโแตฅ ๐น) (๐ธ โแตฅแถ Fโฒ) = Eโฒ/E (โโ ๐ธ) แถโแตฅ ๐น
   /-preserves-โฃโ (E แถโแถ F) (P โแถแถ ๐นโฒ) (.E แถโแถ Fโฒ) = _ โแถแถ ๐นโฒ

   /-preserves-โฃโ (๐ธ โโ Q) (๐ธโฒ โโ .Q) (๐ธโณ โโ .Q) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ

   /-preserves-โฃโ {๐ = แตโแต} (๐ธ แตแตโ Q) (E แตโแต F) (Eโฒ แตโแต .F) = _ แตโแต (push *แต) F
   /-preserves-โฃโ {๐ = แตโแต} (๐ธ แตแตโ Q) (E แตโแต F) (Eโฒ แตโแต .F) = _ แถโแต (push *แต) F
   /-preserves-โฃโ {๐ = แตโแต} (๐ธ แตแตโ Q) (E แตโแถ F) (Eโฒ แตโแถ .F) = _ แตโแถ (push *แถ) F
   /-preserves-โฃโ {๐ = แตโแต} (๐ธ แตแตโ Q) (E แตโแถ F) (Eโฒ แตโแถ .F) = _ แถโแถ (push *แถ) F
   /-preserves-โฃโ {๐ = แตโแต} (๐ธ แตแตโ Q) (๐ธโฒ โแตฅแต F) (๐ธโณ โแตฅแต .F) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โแตฅแต (push *แต) F
   /-preserves-โฃโ {๐ = แตโแต} (๐ธ แตแตโ Q) (๐ธโฒ โแตฅแต F) (๐ธโณ โแตฅแต .F) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โแตฅแถ (push *แต) F
   /-preserves-โฃโ {๐ = แตโแต} (๐ธ แตแตโ Q) (๐ธโฒ โโขแต F) (_โโขแต_ {y = y} {a = a} ๐ธโณ .F) with (pop y *แต) (E/Eโฒ (โโ ๐ธโณ))
   ... | pop-y*E/Eโณ rewrite popโpush y a = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโขแต (push *แถ) F
   /-preserves-โฃโ {๐ = แตโแต} (๐ธ แตแตโ Q) (๐ธโฒ โโขแต F) (๐ธโณ โโขแต .F) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโขแถ (push *แถ) F
   /-preserves-โฃโ {๐ = แตโแต} {๐โฒ = แตโแต} {๐โณ = แตโแต} (๐ธ แตแตโ Q) (๐ธโฒ แตแตโ .Q) (๐ธโณ แตแตโ .Q) =
      /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แตแตโ (push *) Q
   /-preserves-โฃโ {๐ = แตโแต} {๐โฒ = แตโแต} {๐โณ = แตโแต} (๐ธ แตแตโ Q) (๐ธโฒ แตแตโ .Q) (๐ธโณ แตแตโ .Q) =
      /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แตแถโ (push *) Q
   /-preserves-โฃโ {๐ = แตโแต} {๐โฒ = แตโแต} {๐โณ = แตโแต} (๐ธ แตแตโ Q) (๐ธโฒ แตแตโ .Q) (๐ธโณ แตแตโ .Q) =
      /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แตแตโ (push *) Q
   /-preserves-โฃโ {๐ = แตโแต} {๐โฒ = แตโแต} {๐โณ = แตโแต} (๐ธ แตแตโ Q) (๐ธโฒ แตแตโ .Q) (๐ธโณ แตแตโ .Q) =
      /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แตแถโ (push *) Q
   /-preserves-โฃโ {๐ = แตโแต} {แตโแต} {แตโแต} (๐ธ แตแตโ Q) (๐ธโฒ แตแตโ .Q) (๐ธโณ แตแตโ .Q) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แถแตโ (push *) Q
   /-preserves-โฃโ {๐ = แตโแต} {แตโแต} {แตโแต} (๐ธ แตแตโ Q) (๐ธโฒ แตแตโ .Q) (๐ธโณ แตแตโ .Q) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แถแถโ (push *) Q
   /-preserves-โฃโ {๐ = แตโแต} {แตโแต} {แตโแต} (๐ธ แตแตโ Q) (๐ธโฒ แตแตโ .Q) (๐ธโณ แตแตโ .Q) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แถแตโ (push *) Q
   /-preserves-โฃโ {๐ = แตโแต} {แตโแต} {แตโแต} (๐ธ แตแตโ Q) (๐ธโฒ แตแตโ .Q) (๐ธโณ แตแตโ .Q) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แถแถโ (push *) Q
   /-preserves-โฃโ {๐ = แตโแต} (๐ธ แตแตโ Q) (๐ธโฒ แตแถโ .Q) (๐ธโณ แตแถโ .Q) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แตแถโ (push *) Q
   /-preserves-โฃโ {๐ = แตโแต} (๐ธ แตแตโ Q) (๐ธโฒ แตแถโ .Q) (๐ธโณ แตแถโ .Q) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ แถแถโ (push *) Q

   /-preserves-โฃโ {๐ = แตโแต} (P โแตแต ๐น) (E แตโโข ๐นโฒ) (.E แตโโข ๐นโณ) = (push *แต) E แถโโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} (P โแตแต ๐น) (E แตโโข ๐นโฒ) (.E แตโโข ๐นโณ) = (push *แต) E แตโโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} (P โแตแต ๐น) (_แตโแตฅ_ {๐ = แตโแต} E ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} .E ๐นโณ) =
      (push *แต) E แตโแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} (P โแตแต ๐น) (_แตโแตฅ_ {๐ = แตโแต} E ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} .E ๐นโณ) =
      (push *แต) E แตโโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} (P โแตแต ๐น) (_แตโแตฅ_ {๐ = แตโแต} E ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} .E ๐นโณ) =
      (push *แต) E แตโแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} (P โแตแต ๐น) (_แตโแตฅ_ {๐ = แตโแต} E ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} .E ๐นโณ) =
      (push *แต) E แตโโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} (P โแตแต ๐น) (_แตโแตฅ_ {๐ = แตโแต} E ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} .E ๐นโณ) =
      (push *แต) E แถโแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} (P โแตแต ๐น) (_แตโแตฅ_ {๐ = แตโแต} E ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} .E ๐นโณ) =
      (push *แต) E แถโแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} (P โแตแต ๐น) (_แตโแตฅ_ {๐ = แตโแต} E ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} .E ๐นโณ) =
      (push *แต) E แถโโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} (P โแตแต ๐น) (_แตโแตฅ_ {๐ = แตโแต} E ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} .E ๐นโณ) =
      (push *แต) E แถโโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} {๐โณ = แตโแต} (P โแตแต ๐น) (.P โแตแต ๐นโฒ) (.P โแตแต ๐นโณ) =
      (push *) P โแตแต /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} {๐โฒ = แตโแต} {๐โณ = แตโแต} (P โแตแต ๐น) (.P โแตแต ๐นโฒ) (.P โแตแต ๐นโณ) =
      (push *) P โแตแถ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} {๐โฒ = แตโแต} {๐โณ = แตโแต} (P โแตแต ๐น) (.P โแตแต ๐นโฒ) (.P โแตแต ๐นโณ) =
      (push *) P โแตแถ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} {๐โฒ = แตโแต} {๐โณ = แตโแต} (P โแตแต ๐น) (.P โแตแต ๐นโฒ) (.P โแตแต ๐นโณ) =
      (push *) P โแถแต /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} {๐โฒ = แตโแต} {๐โณ = แตโแต} (P โแตแต ๐น) (.P โแตแต ๐นโฒ) (.P โแตแต ๐นโณ) =
      (push *) P โแถแถ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} {๐โฒ = แตโแต} {๐โณ = แตโแต} (P โแตแต ๐น) (.P โแตแต ๐นโฒ) (.P โแตแต ๐นโณ) =
      (push *) P โแถแต /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} {๐โฒ = แตโแต} {๐โณ = แตโแต} (P โแตแต ๐น) (.P โแตแต ๐นโฒ) (.P โแตแต ๐นโณ) =
      (push *) P โแถแถ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} (P โแตแต ๐น) (.P โแตแถ ๐นโฒ) (.P โแตแถ ๐นโณ) = (push *) P โแตแถ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ {๐ = แตโแต} (P โแตแต ๐น) (.P โแตแถ ๐นโฒ) (.P โแตแถ ๐นโณ) = (push *) P โแถแถ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ

   /-preserves-โฃโ (_โโขแต_ {y = y} {a = a} ๐ธ F) (๐ธโฒ โโข ๐น) (_โโขแต_ {y = z} {a = .a} ๐ธโณ Fโฒ)
      with (pop y *แต) (E/Eโฒ (โโ ๐ธ)) | (pop z *แต) (E/Eโฒ (โโ ๐ธโณ))
   ... | pop-y*E/Eโฒ | pop-y*E/Eโณ rewrite popโpush y a | popโpush z a = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโข (push *แถแถโฃ) ๐น
   /-preserves-โฃโ (_โโขแต_ {y = y} {a = a} ๐ธ F) (๐ธโฒ โโขแตฅ ๐น) (๐ธโณ โแตฅแต Fโฒ) with (pop y *แต) (E/Eโฒ (โโ ๐ธ))
   ... | pop-y*E/Eโฒ rewrite popโpush y a = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโขแตฅ (push *แถแตโฃ) ๐น

   /-preserves-โฃโ (_โโขแถ_ {y = y} {a = a} ๐ธ F) (_โโข_ {x = x} {.y} {u} {z} ๐ธโฒ ๐น) (๐ธโณ โโขแถ Fโฒ)
      with (pop y *แถ) (E/Eโฒ (โโ ๐ธ)) | (pop y *แต) (Eโฒ/E (โโ ๐ธโฒ)) | (pop z *แต) (E/Eโฒ (โโ ๐ธโฒ)) | (pop z *แถ) (E/Eโฒ (โโ ๐ธโณ))
   ... | pop-y*E/Eโฒ | pop-y*Eโณ/Eโฒ | pop-z*Eโฒ/Eโณ | pop-z*E/Eโณ
      rewrite popโpush y a | popโpush u y | popโpush x z | popโpush z a = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโข ๐น
   /-preserves-โฃโ (_โโขแถ_ {y = y} {a = a} ๐ธ F) (๐ธโฒ โโขแตฅ ๐นโฒ) (๐ธโณ โแตฅแถ Fโฒ) with (pop y *แถ) (E/Eโฒ (โโ ๐ธ))
   ... | pop-y*E/Eโฒ rewrite popโpush y a = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ โโขแตฅ ๐นโฒ

   /-preserves-โฃโ (E แตโโข ๐น) (๐ธ โโข ๐นโฒ) (Eโฒ แตโโข ๐นโณ) = (push *แตแตโฃ) ๐ธ โโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (E แตโโข ๐น) (๐ธ โโขแตฅ ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} Eโฒ ๐นโณ) = (push *แตแตโฃ) ๐ธ โโขแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (E แตโโข ๐น) (๐ธ โโขแตฅ ๐นโฒ) (_แตโแตฅ_ {๐ = แตโแต} Eโฒ ๐นโณ) = (push *แตแตโฃ) ๐ธ โโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ

   /-preserves-โฃโ (E แถโโข ๐น) (๐ธโฒ โโข ๐นโฒ) (Eโฒ แถโโข ๐นโณ) = ๐ธโฒ โโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (E แถโโข ๐น) (๐ธโฒ โโขแตฅ ๐นโฒ) (Eโฒ แถโแตฅ ๐นโณ) = ๐ธโฒ โโขแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ

   /-preserves-โฃโ (๐ธ โโข ๐น) (๐ธโฒ โโข ๐นโฒ) (๐ธโณ โโข ๐นโณ) = (pop _ *แตแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ) โโข /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ
   /-preserves-โฃโ (๐ธ โโข ๐น) (๐ธโฒ โโขแตฅ ๐นโฒ) (๐ธโณ โโขแตฅ ๐นโณ) = (pop _ *แตแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ) โโขแตฅ /-preserves-โฃโ ๐น ๐นโฒ ๐นโณ

   /-preserves-โฃโ (ฮฝโข ๐ธ) (ฮฝโข ๐ธโฒ) (ฮฝโข ๐ธโณ) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ
   /-preserves-โฃโ (ฮฝโข ๐ธ) (ฮฝโขแต ๐ธโฒ) (ฮฝโขแต ๐ธโณ) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ
   /-preserves-โฃโ (ฮฝโข ๐ธ) (ฮฝโขแถ ๐ธโฒ) (ฮฝโขแถ ๐ธโณ) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ

   /-preserves-โฃโ (ฮฝโขแต ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝโขแต ๐ธโณ) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ
   /-preserves-โฃโ (ฮฝโขแต ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝโขแต ๐ธโณ) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ
   /-preserves-โฃโ (ฮฝโขแต ๐ธ) (ฮฝแตแถ ๐ธโฒ) (ฮฝโขแถ ๐ธโณ) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ

   /-preserves-โฃโ (ฮฝโขแถ ๐ธ) (ฮฝแถแถ ๐ธโฒ) (ฮฝโขแถ ๐ธโณ) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ
   /-preserves-โฃโ (ฮฝโขแถ ๐ธ) (ฮฝแถแต ๐ธโฒ) (ฮฝโขแต ๐ธโณ) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ

   /-preserves-โฃโ (ฮฝแตแต_ {a = x โข} {a} ๐ธ) (ฮฝแตแต_ {aโฒ = aโฒ} ๐ธโฒ) (ฮฝแตแต ๐ธโณ)
      with (swap *แต) (Eโฒ/E (โโ ๐ธ)) | (swap *แต) (Eโฒ/E (โโ ๐ธโณ)) | (swap *แตแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   ... | swap*Eโฒ/E | swap*Eโณ/E | swap*Eโฒ/๐ธโณ/E rewrite swapโpushโpush x | swapโpushโpush a | swapโpushโpush aโฒ =
      ฮฝแตแต swap*Eโฒ/๐ธโณ/E
   /-preserves-โฃโ (ฮฝแตแต_ {a = โข x} {aโฒ = u โข} ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝแตแต_ {aโฒ = โข y} ๐ธโณ) = ฮฝแตแต (swap *แตแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   /-preserves-โฃโ (ฮฝแตแต_ {a = โข x} {aโฒ = โข u} ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝแตแต_ {aโฒ = โข y} ๐ธโณ) = ฮฝแตแต (swap *แตแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   /-preserves-โฃโ (ฮฝแตแต_ {a = โข x} {aโฒ = โข u} ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝแตแต_ {aโฒ = y โข} ๐ธโณ) = ฮฝแตแต (swap *แตแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   /-preserves-โฃโ (ฮฝแตแต_ {a = โข x} {aโฒ = u โข} ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝแตแต_ {aโฒ = y โข} ๐ธโณ) = ฮฝแตแต (swap *แตแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   /-preserves-โฃโ (ฮฝแตแต_ {a = โข x} {aโฒ = u โข} ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝแตแต ๐ธโณ) = ฮฝแตแถ (swap *แตแถโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   /-preserves-โฃโ (ฮฝแตแต_ {a = โข x} {aโฒ = โข u} ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝแตแต ๐ธโณ) = ฮฝแตแถ (swap *แตแถโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   /-preserves-โฃโ (ฮฝแตแต_ {a = x โข} ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝแตแต ๐ธโณ) = ฮฝแตแต (swap *แตแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   /-preserves-โฃโ (ฮฝแตแต_ {a = โข x} ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝแตแต ๐ธโณ) = ฮฝแตแต (swap *แตแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   /-preserves-โฃโ (ฮฝแตแต ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝแตแต ๐ธโณ) = ฮฝแตแถ (swap *แตแถโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   /-preserves-โฃโ (ฮฝแตแต_ {a = x โข} {a} ๐ธ) (ฮฝแตแถ_ {aโฒ = aโฒ} ๐ธโฒ) (ฮฝแตแถ ๐ธโณ)
      with (swap *แต) (Eโฒ/E (โโ ๐ธ)) | (swap *แถ) (Eโฒ/E (โโ ๐ธโณ)) | (swap *แตแถโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   ... | swap*Eโฒ/E | swap*Eโณ/E | swap*Eโฒ/๐ธโณ/E rewrite swapโpushโpush a | swapโpushโpush aโฒ = ฮฝแตแถ swap*Eโฒ/๐ธโณ/E
   /-preserves-โฃโ (ฮฝแตแต_ {a = โข x} {u โข} ๐ธ) (ฮฝแตแถ_ {aโฒ = aโฒ} ๐ธโฒ) (ฮฝแตแถ ๐ธโณ)
      with (swap *แต) (Eโฒ/E (โโ ๐ธ)) | (swap *แถ) (Eโฒ/E (โโ ๐ธโณ)) | (swap *แตแถโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   ... | swap*Eโฒ/E | swap*Eโณ/E | swap*Eโฒ/๐ธโณ/E rewrite swapโpushโpush aโฒ = ฮฝแตแถ swap*Eโฒ/๐ธโณ/E
   /-preserves-โฃโ (ฮฝแตแต_ {a = โข x} {โข u} ๐ธ) (ฮฝแตแถ_ {aโฒ = aโฒ} ๐ธโฒ) (ฮฝแตแถ ๐ธโณ)
      with (swap *แต) (Eโฒ/E (โโ ๐ธ)) | (swap *แถ) (Eโฒ/E (โโ ๐ธโณ)) | (swap *แตแถโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   ... | swap*Eโฒ/E | swap*Eโณ/E | swap*Eโฒ/๐ธโณ/E rewrite swapโpushโpush aโฒ = ฮฝแตแถ swap*Eโฒ/๐ธโณ/E

   /-preserves-โฃโ (ฮฝแตแต ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝแตแต ๐ธโณ)
      with (swap *แถ) (Eโฒ/E (โโ ๐ธ)) | (swap *แต) (Eโฒ/E (โโ ๐ธโณ)) | (swap *แถแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   ... | swap*Eโฒ/E | swap*Eโณ/E | swap*Eโฒ/๐ธโณ/E = ฮฝแถแต swap*Eโฒ/๐ธโณ/E
   /-preserves-โฃโ (ฮฝแตแต ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝแตแต ๐ธโณ) = ฮฝแถแถ (swap *แถแถโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   /-preserves-โฃโ (ฮฝแตแต ๐ธ) (ฮฝแตแถ_ {aโฒ = aโฒ} ๐ธโฒ) (ฮฝแตแถ ๐ธโณ)
      with (swap *แถ) (Eโฒ/E (โโ ๐ธ)) | (swap *แถ) (Eโฒ/E (โโ ๐ธโณ)) | (swap *แถแถโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   ... | swap*Eโฒ/E | swap*Eโณ/E | swap*Eโฒ/๐ธโณ/E rewrite swapโpushโpush aโฒ = ฮฝแถแถ swap*Eโฒ/๐ธโณ/E
   /-preserves-โฃโ (ฮฝแตแต ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝแตแต_ {aโฒ = x โข} ๐ธโณ)
      with (swap *แถ) (Eโฒ/E (โโ ๐ธ)) | (swap *แต) (Eโฒ/E (โโ ๐ธโณ)) | (swap *แถแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   ... | swap*Eโฒ/E | swap*Eโณ/E | swap*Eโฒ/๐ธโณ/E = ฮฝแถแต swap*Eโฒ/๐ธโณ/E
   /-preserves-โฃโ (ฮฝแตแต ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝแตแต_ {aโฒ = โข x} ๐ธโณ)
      with (swap *แถ) (Eโฒ/E (โโ ๐ธ)) | (swap *แต) (Eโฒ/E (โโ ๐ธโณ)) | (swap *แถแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   ... | swap*Eโฒ/E | swap*Eโณ/E | swap*Eโฒ/๐ธโณ/E = ฮฝแถแต swap*Eโฒ/๐ธโณ/E
   /-preserves-โฃโ (ฮฝแตแต ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝแตแต ๐ธโณ) = ฮฝแถแถ (swap *แถแถโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)

   /-preserves-โฃโ (ฮฝแตแถ_ {aโฒ = aโฒ} ๐ธ) (ฮฝแถแถ ๐ธโฒ) (ฮฝแตแถ_ {aโฒ = aโณ} ๐ธโณ)
      with (swap *แถ) (Eโฒ/E (โโ ๐ธ)) | (swap *แถ) (Eโฒ/E (โโ ๐ธโณ)) | (swap *แถแถโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   ... | swap*Eโฒ/E | swap*Eโณ/E | swap*Eโฒ/๐ธโณ/E rewrite swapโpushโpush aโฒ | swapโpushโpush aโณ = ฮฝแถแถ swap*Eโฒ/๐ธโณ/E
   /-preserves-โฃโ (ฮฝแตแถ ๐ธ) (ฮฝแถแต_ {a = a} {aโฒ} ๐ธโฒ) (ฮฝแตแต_ {a = x โข} ๐ธโณ)
      with (swap *แถ) (Eโฒ/E (โโ ๐ธ)) | (swap *แต) (E/Eโฒ (โโ ๐ธโณ)) | (swap *แต) (Eโฒ/E (โโ ๐ธโณ)) |
           (swap *แถแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   ... | swap*Eโฒ/E | swap*E/Eโณ | swap*Eโณ/E | swap*Eโฒ/๐ธโณ/E rewrite swapโpushโpush a | swapโpushโpush aโฒ =
      ฮฝแถแต swap*Eโฒ/๐ธโณ/E

   /-preserves-โฃโ (ฮฝแตแถ_ {aโฒ = aโฒ} ๐ธ) (ฮฝแถแต ๐ธโฒ) (ฮฝแตแต_ {a = โข x} {u โข} ๐ธโณ)
      with (swap *แถ) (Eโฒ/E (โโ ๐ธ)) | (swap *แต) (E/Eโฒ (โโ ๐ธโณ)) | (swap *แต) (Eโฒ/E (โโ ๐ธโณ)) |
           (swap *แถแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   ... | swap*Eโฒ/E | swap*E/Eโณ | swap*Eโณ/E | swap*Eโฒ/๐ธโณ/E rewrite swapโpushโpush aโฒ = ฮฝแถแต swap*Eโฒ/๐ธโณ/E
   /-preserves-โฃโ (ฮฝแตแถ_ {aโฒ = aโฒ} ๐ธ) (ฮฝแถแต ๐ธโฒ) (ฮฝแตแต_ {a = โข x} {โข u} ๐ธโณ)
      with (swap *แถ) (Eโฒ/E (โโ ๐ธ)) | (swap *แต) (E/Eโฒ (โโ ๐ธโณ)) | (swap *แต) (Eโฒ/E (โโ ๐ธโณ)) |
           (swap *แถแตโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   ... | swap*Eโฒ/E | swap*E/Eโณ | swap*Eโณ/E | swap*Eโฒ/๐ธโณ/E rewrite swapโpushโpush aโฒ = ฮฝแถแต swap*Eโฒ/๐ธโณ/E
   /-preserves-โฃโ (ฮฝแตแถ_ {aโฒ = aโฒ} ๐ธ) (ฮฝแถแต ๐ธโฒ) (ฮฝแตแต ๐ธโณ)
      with (swap *แถ) (Eโฒ/E (โโ ๐ธ)) | (swap *แถ) (E/Eโฒ (โโ ๐ธโณ)) | (swap *แถ) (Eโฒ/E (โโ ๐ธโณ)) |
           (swap *แถแถโฃ) (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)
   ... | swap*Eโฒ/E | swap*E/Eโณ | swap*Eโณ/E | swap*Eโฒ/๐ธโณ/E rewrite swapโpushโpush aโฒ = ฮฝแถแถ swap*Eโฒ/๐ธโณ/E

   /-preserves-โฃโ (ฮฝแถแต_ {a = a} ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝแถแต ๐ธโณ) with (swap *แถ) (E/Eโฒ (โโ ๐ธ)) | (swap *แถ) (E/Eโฒ (โโ ๐ธโณ))
   ... | swap*E/Eโฒ | swap*E/Eโณ rewrite swapโpushโpush a = ฮฝแตแต /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ
   /-preserves-โฃโ (ฮฝแถแต_ {a = a} ๐ธ) (ฮฝแตแต ๐ธโฒ) (ฮฝแถแต ๐ธโณ) with (swap *แถ) (E/Eโฒ (โโ ๐ธ)) | (swap *แถ) (E/Eโฒ (โโ ๐ธโณ))
   ... | swap*E/Eโฒ | swap*E/Eโณ rewrite swapโpushโpush a = ฮฝแตแต /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ
   /-preserves-โฃโ (ฮฝแถแต_ {a = a} ๐ธ) (ฮฝแตแถ ๐ธโฒ) (ฮฝแถแถ ๐ธโณ) with (swap *แถ) (E/Eโฒ (โโ ๐ธ))
   ... | swap*E/Eโฒ rewrite swapโpushโpush a = ฮฝแตแถ /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ

   /-preserves-โฃโ (ฮฝแถแถ ๐ธ) (ฮฝแถแถ ๐ธโฒ) (ฮฝแถแถ ๐ธโณ) = ฮฝแถแถ /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ
   /-preserves-โฃโ (ฮฝแถแถ_ {a = a} ๐ธ) (ฮฝแถแต ๐ธโฒ) (ฮฝแถแต ๐ธโณ) with (swap *แถ) (E/Eโฒ (โโ ๐ธโณ))
   ... | swap*E/Eโณ rewrite swapโpushโpush a = ฮฝแถแต (/-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ)

   /-preserves-โฃโ (! ๐ธ) (! ๐ธโฒ) (! ๐ธโณ) = /-preserves-โฃโ ๐ธ ๐ธโฒ ๐ธโณ
