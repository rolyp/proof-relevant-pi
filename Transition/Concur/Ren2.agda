-- Concurrent transitions are closed under renamings.
module Transition.Concur.Ren2 where

   open import SharedModules

   open import Action as แดฌ using (Action; _แดฌโฃ_); open แดฌ._แดฌโฃ_; open แดฌ.Action; open แดฌ.Actionแต
   open import Proc using (Proc)
   open import Ren as แดฟ using (Ren; suc); open แดฟ.Renameable โฆ...โฆ
   open import Ren.Properties
   open import Transition using (_โ[_-_]โ_)
   open import Transition.Concur2 using (แดฌโ; Concur; module Concur; Concurโ; module Concurโ);
      open Concur; open Concurโ
   open import Transition.Ren

   -- Only in the two แตโแต cases is the outcome not uniquely determined by the types; in each case
   -- extrusions of the same binder are preserved.
   /-preserves-แดฌโฃ : โ {ฮ} {a aโฒ aโณ : Action ฮ} (aโฃaโฒ : a แดฌโฃ aโฒ) (aโฒโฃaโณ : aโฒ แดฌโฃ aโณ) (aโฃaโณ : a แดฌโฃ aโณ) โ
         ฯโ (แดฌโ aโฃaโฒ) แดฌโฃ ฯโ (แดฌโ aโฃaโณ)
   /-preserves-แดฌโฃ แตโแต แตโแต แตโแต = แถโแถ
   /-preserves-แดฌโฃ แตโแต แตโแต แตโแต = แถโแต
   /-preserves-แดฌโฃ แตโแต แตโแต แตโแต = แถโแถ
   /-preserves-แดฌโฃ แตโแต แตโแต แตโแต = แถโแต
   /-preserves-แดฌโฃ แตโแต แตโแถ แตโแถ = แถโแถ
   /-preserves-แดฌโฃ แตโแต แตโแต แตโแต = แตโแถ
   /-preserves-แดฌโฃ แตโแต แตโแต แตโแต = แตโแต
   /-preserves-แดฌโฃ แตโแต แตโแต แตโแต = แตโแถ
   /-preserves-แดฌโฃ แตโแต แตโแต แตโแต = แตโแต
   /-preserves-แดฌโฃ แตโแต แตโแถ แตโแถ = แตโแถ
   /-preserves-แดฌโฃ แตโแถ แถโแต แตโแต = แถโแถ
   /-preserves-แดฌโฃ แตโแถ แถโแต แตโแต = แถโแต
   /-preserves-แดฌโฃ แตโแถ แถโแถ แตโแถ = แถโแถ
   /-preserves-แดฌโฃ แถโแต แตโแต แถโแต = แตโแต
   /-preserves-แดฌโฃ แถโแต แตโแต แถโแต = แตโแต
   /-preserves-แดฌโฃ แถโแต แตโแถ แถโแถ = แตโแถ
   /-preserves-แดฌโฃ แถโแถ แถโแต แถโแต = แถโแต
   /-preserves-แดฌโฃ แถโแถ แถโแถ แถโแถ = แถโแถ

   -- Concurrent actions are preserved by renamings.
   _*แดฌโฃ : โ {ฮ ฮโฒ} {a aโฒ : Action ฮ} (ฯ : Ren ฮ ฮโฒ) (aโฃaโฒ : a แดฌโฃ aโฒ) โ (ฯ *) a แดฌโฃ (ฯ *) aโฒ
   (ฯ *แดฌโฃ) แตโแต = แตโแต
   (ฯ *แดฌโฃ) แตโแต = แตโแต
   (ฯ *แดฌโฃ) แตโแถ = แตโแถ
   (ฯ *แดฌโฃ) แถโแต = แถโแต
   (ฯ *แดฌโฃ) แถโแถ = แถโแถ

   _*แตแตโฃโ : โ {ฮ ฮโฒ} {P : Proc ฮ} {a aโฒ R Rโฒ} {aโฃaโฒ : a แต แดฌโฃ aโฒ แต} {E : P โ[ a แต - _ ]โ R} {Eโฒ : P โ[ aโฒ แต - _ ]โ Rโฒ}
           (ฯ : Ren ฮ ฮโฒ) โ E โฃโ[ aโฃaโฒ ] Eโฒ โ (ฯ *แต) E โฃโ[ (ฯ *แดฌโฃ) aโฃaโฒ ] (ฯ *แต) Eโฒ
   _*แถแถโฃโ : โ {ฮ ฮโฒ} {P : Proc ฮ} {a aโฒ R Rโฒ} {aโฃaโฒ : a แถ แดฌโฃ aโฒ แถ} {E : P โ[ a แถ - _ ]โ R} {Eโฒ : P โ[ aโฒ แถ - _ ]โ Rโฒ}
           (ฯ : Ren ฮ ฮโฒ) โ E โฃโ[ aโฃaโฒ ] Eโฒ โ (ฯ *แถ) E โฃโ[ (ฯ *แดฌโฃ) aโฃaโฒ ] (ฯ *แถ) Eโฒ
   _*แถแตโฃโ : โ {ฮ ฮโฒ} {P : Proc ฮ} {a aโฒ R Rโฒ} {aโฃaโฒ : a แถ แดฌโฃ aโฒ แต} {E : P โ[ a แถ - _ ]โ R} {Eโฒ : P โ[ aโฒ แต - _ ]โ Rโฒ}
           (ฯ : Ren ฮ ฮโฒ) โ E โฃโ[ aโฃaโฒ ] Eโฒ โ (ฯ *แถ) E โฃโ[ (ฯ *แดฌโฃ) aโฃaโฒ ] (ฯ *แต) Eโฒ
   _*แตแถโฃโ : โ {ฮ ฮโฒ} {P : Proc ฮ} {a aโฒ R Rโฒ} {aโฃaโฒ : a แต แดฌโฃ aโฒ แถ} {E : P โ[ a แต - _ ]โ R} {Eโฒ : P โ[ aโฒ แถ - _ ]โ Rโฒ}
           (ฯ : Ren ฮ ฮโฒ) โ E โฃโ[ aโฃaโฒ ] Eโฒ โ (ฯ *แต) E โฃโ[ (ฯ *แดฌโฃ) aโฃaโฒ ] (ฯ *แถ) Eโฒ

   _*แตแตโฃ : โ {ฮ ฮโฒ} {P : Proc ฮ} {a aโฒ R Rโฒ} {aโฃaโฒ : a แต แดฌโฃ aโฒ แต} {E : P โ[ a แต - _ ]โ R} {Eโฒ : P โ[ aโฒ แต - _ ]โ Rโฒ}
          (ฯ : Ren ฮ ฮโฒ) โ E โฃ[ aโฃaโฒ ] Eโฒ โ (ฯ *แต) E โฃ[ (ฯ *แดฌโฃ) aโฃaโฒ ] (ฯ *แต) Eโฒ
   (ฯ *แตแตโฃ) ๐ธ = {!!}

   _*แถแถโฃ : โ {ฮ ฮโฒ} {P : Proc ฮ} {a aโฒ R Rโฒ} {aโฃaโฒ : a แถ แดฌโฃ aโฒ แถ} {E : P โ[ a แถ - _ ]โ R} {Eโฒ : P โ[ aโฒ แถ - _ ]โ Rโฒ}
          (ฯ : Ren ฮ ฮโฒ) โ E โฃ[ aโฃaโฒ ] Eโฒ โ (ฯ *แถ) E โฃ[ (ฯ *แดฌโฃ) aโฃaโฒ ] (ฯ *แถ) Eโฒ
   (ฯ *แถแถโฃ) ๐ธ = {!!}

   _*แถแตโฃ : โ {ฮ ฮโฒ} {P : Proc ฮ} {a aโฒ R Rโฒ} {aโฃaโฒ : a แถ แดฌโฃ aโฒ แต} {E : P โ[ a แถ - _ ]โ R} {Eโฒ : P โ[ aโฒ แต - _ ]โ Rโฒ}
          (ฯ : Ren ฮ ฮโฒ) โ E โฃ[ aโฃaโฒ ] Eโฒ โ (ฯ *แถ) E โฃ[ (ฯ *แดฌโฃ) aโฃaโฒ ] (ฯ *แต) Eโฒ
   (ฯ *แถแตโฃ) ๐ธ = {!!}

   _*แตแถโฃ : โ {ฮ ฮโฒ} {P : Proc ฮ} {a aโฒ R Rโฒ} {aโฃaโฒ : a แต แดฌโฃ aโฒ แถ} {E : P โ[ a แต - _ ]โ R} {Eโฒ : P โ[ aโฒ แถ - _ ]โ Rโฒ}
          (ฯ : Ren ฮ ฮโฒ) โ E โฃ[ aโฃaโฒ ] Eโฒ โ (ฯ *แต) E โฃ[ (ฯ *แดฌโฃ) aโฃaโฒ ] (ฯ *แถ) Eโฒ
   (ฯ *แตแถโฃ) ๐ธ = {!!}

   (ฯ *แตแตโฃโ) (_แตโแต_ {P = P} {Q} E F) rewrite แดฟ+-comm 1 ฯ P | แดฟ+-comm 1 ฯ Q = (ฯ *แต) E แตโแต (ฯ *แต) F
   (ฯ *แตแตโฃโ) (EโฃEโฒ โโ Q) = (ฯ *แตแตโฃ) EโฃEโฒ โโ _
   (ฯ *แตแตโฃโ) (P โแตแต FโฃFโฒ) rewrite แดฟ+-comm 1 ฯ P = (ฯ *) P โแตแต (ฯ *แตแตโฃ) FโฃFโฒ
   (ฯ *แตแตโฃโ) (EโฃEโฒ แตแตโ Q) rewrite แดฟ+-comm 1 ฯ Q = (ฯ *แตแตโฃ) EโฃEโฒ แตแตโ (ฯ *) Q
   (ฯ *แตแตโฃโ) (ฮฝโข EโฃEโฒ) = ฮฝโข (suc ฯ *แถแถโฃ) EโฃEโฒ
   (ฯ *แตแตโฃโ) (ฮฝโขแต_ {R = R} {Rโฒ} {a} {E} {Eโฒ} EโฃEโฒ) with (suc ฯ *แต) Eโฒ | (suc ฯ *แถแตโฃ) EโฃEโฒ
   ... | _ | suc-ฯ*EโฃEโฒ rewrite แดฟ+-comm 1 ฯ a | sym (swap-suc-suc ฯ Rโฒ) = ฮฝโขแต suc-ฯ*EโฃEโฒ
   (ฯ *แตแตโฃโ) (ฮฝแตแต_ {R = R} {Rโฒ} {a} {aโฒ} {E} {Eโฒ} EโฃEโฒ) with (suc ฯ *แต) E | (suc ฯ *แต) Eโฒ | (suc ฯ *แตแตโฃ) EโฃEโฒ
   ... | _ | _ | suc-ฯ*EโฃEโฒ
      rewrite แดฟ+-comm 1 ฯ a | sym (swap-suc-suc ฯ R) | แดฟ+-comm 1 ฯ aโฒ | sym (swap-suc-suc ฯ Rโฒ) = ฮฝแตแต suc-ฯ*EโฃEโฒ
   (ฯ *แตแตโฃโ) (ฮฝแตแต_ {R = R} {Rโฒ} {x} {u} {E} {Eโฒ} EโฃEโฒ) with (suc ฯ *แต) E | (suc ฯ *แต) Eโฒ | (suc ฯ *แตแตโฃ) EโฃEโฒ
   ... | _ | _ | suc-ฯ*EโฃEโฒ
      rewrite แดฟ+-comm 1 ฯ (โข x) | sym (swap-suc-suc ฯ R) | แดฟ+-comm 1 ฯ (โข u) | sym (swap-suc-suc ฯ Rโฒ) = ฮฝแตแต suc-ฯ*EโฃEโฒ
   (ฯ *แตแตโฃโ) (! EโฃEโฒ) = ! (ฯ *แตแตโฃ) EโฃEโฒ

   (ฯ *แถแตโฃโ) (_แถโแต_ {P = P} E F) rewrite แดฟ+-comm 1 ฯ P = (ฯ *แถ) E แถโแต (ฯ *แต) F
   (ฯ *แถแตโฃโ) (EโฃEโฒ โโ Q) = (ฯ *แถแตโฃ) EโฃEโฒ โโ _
   (ฯ *แถแตโฃโ) (! EโฃEโฒ) = ! (ฯ *แถแตโฃ) EโฃEโฒ

   (ฯ *แตแถโฃโ) (_แตโแถ_ {Q = Q} E F) rewrite แดฟ+-comm 1 ฯ Q = (ฯ *แต) E แตโแถ (ฯ *แถ) F
   (ฯ *แตแถโฃโ) (_โโขแต_ {y = y} {Rโฒ = Rโฒ} {Q = Q} EโฃEโฒ F) rewrite แดฟ+-comm 1 ฯ Q | pop-comm ฯ y Rโฒ = (ฯ *แตแตโฃ) EโฃEโฒ โโขแต (ฯ *แถ) F
   (ฯ *แตแถโฃโ) (_แตโโข_ {y = y} {P} {R = R} E FโฃFโฒ) rewrite แดฟ+-comm 1 ฯ P | pop-comm ฯ y R = (ฯ *แต) E แตโโข (ฯ *แตแถโฃ) FโฃFโฒ
   (ฯ *แตแถโฃโ) (_โแตฅแต_ {Q = Q} EโฃEโฒ F) rewrite แดฟ+-comm 1 ฯ Q = (ฯ *แตแตโฃ) EโฃEโฒ โแตฅแต (ฯ *แต) F
   (ฯ *แตแถโฃโ) (_แตโแตฅ_ {P = P} E FโฃFโฒ) rewrite แดฟ+-comm 1 ฯ P = (ฯ *แต) E แตโแตฅ (ฯ *แตแตโฃ) FโฃFโฒ
   (ฯ *แตแถโฃโ) (EโฃEโฒ โโ Q) = (ฯ *แตแถโฃ) EโฃEโฒ โโ _
   (ฯ *แตแถโฃโ) (P โแตแถ EโฃEโฒ) rewrite แดฟ+-comm 1 ฯ P = (ฯ *) P โแตแถ (ฯ *แตแถโฃ) EโฃEโฒ
   (ฯ *แตแถโฃโ) (EโฃEโฒ แตแถโ Q) rewrite แดฟ+-comm 1 ฯ Q = (ฯ *แตแถโฃ) EโฃEโฒ แตแถโ (ฯ *) Q
   (ฯ *แตแถโฃโ) (ฮฝโขแถ_ {a = a} {E} {Eโฒ} EโฃEโฒ) with (suc ฯ *แถ) Eโฒ | (suc ฯ *แถแถโฃ) EโฃEโฒ
   ... | _ | suc-ฯ*EโฃEโฒ rewrite แดฟ+-comm 1 ฯ a = ฮฝโขแถ suc-ฯ*EโฃEโฒ
   (ฯ *แตแถโฃโ) (ฮฝแตแถ_ {R = R} {a = a} {aโฒ} {E} {Eโฒ} EโฃEโฒ) with (suc ฯ *แต) E | (suc ฯ *แถ) Eโฒ | (suc ฯ *แตแถโฃ) EโฃEโฒ
   ... | _ | _ | suc-ฯ*EโฃEโฒ rewrite แดฟ+-comm 1 ฯ a | แดฟ+-comm 1 ฯ aโฒ | sym (swap-suc-suc ฯ R) = ฮฝแตแถ suc-ฯ*EโฃEโฒ
   (ฯ *แตแถโฃโ) (! EโฃEโฒ) = ! (ฯ *แตแถโฃ) EโฃEโฒ

   (ฯ *แถแถโฃโ) (E แถโแถ F) = (ฯ *แถ) E แถโแถ (ฯ *แถ) F
   (ฯ *แถแถโฃโ) (_โโขแถ_ {y = y} {Rโฒ = Rโฒ} EโฃEโฒ F) rewrite pop-comm ฯ y Rโฒ = (ฯ *แถแตโฃ) EโฃEโฒ โโขแถ (ฯ *แถ) F
   (ฯ *แถแถโฃโ) (_แถโโข_ {y = y} {R = R} E FโฃFโฒ) rewrite pop-comm ฯ y R = (ฯ *แต) E แถโโข (ฯ *แถแถโฃ) FโฃFโฒ
   (ฯ *แถแถโฃโ) (EโฃEโฒ โแตฅแถ F) = (ฯ *แถแตโฃ) EโฃEโฒ โแตฅแถ (ฯ *แต) F
   (ฯ *แถแถโฃโ) (E แถโแตฅ FโฃFโฒ) = (ฯ *แต) E แถโแตฅ (ฯ *แถแตโฃ) FโฃFโฒ
   (ฯ *แถแถโฃโ) (EโฃEโฒ โโ Q) = (ฯ *แถแถโฃ) EโฃEโฒ โโ (ฯ *) Q
   (ฯ *แถแถโฃโ) (P โแถแถ FโฃFโฒ) = (ฯ *) P โแถแถ (ฯ *แถแถโฃ) FโฃFโฒ
   (ฯ *แถแถโฃโ) (EโฃEโฒ แถแถโ Q) = (ฯ *แถแถโฃ) EโฃEโฒ แถแถโ (ฯ *) Q
   (ฯ *แถแถโฃโ) (_โโข_ {y = y} {z = z} {R = R} {Rโฒ} EโฃEโฒ FโฃFโฒ) rewrite pop-comm ฯ y R | pop-comm ฯ z Rโฒ =
      (ฯ *แตแตโฃ) EโฃEโฒ โโข (ฯ *แถแถโฃ) FโฃFโฒ
   (ฯ *แถแถโฃโ) (_โแตฅโข_ {y = y} {Rโฒ = Rโฒ} EโฃEโฒ FโฃFโฒ) rewrite pop-comm ฯ y Rโฒ = (ฯ *แตแตโฃ) EโฃEโฒ โแตฅโข (ฯ *แตแถโฃ) FโฃFโฒ
   (ฯ *แถแถโฃโ) (EโฃEโฒ โแตฅ FโฃFโฒ) = (ฯ *แตแตโฃ) EโฃEโฒ โแตฅ (ฯ *แตแตโฃ) FโฃFโฒ
   (ฯ *แถแถโฃโ) (ฮฝแถแถ_ {a = a} {aโฒ} {E} {Eโฒ} EโฃEโฒ) with (suc ฯ *แถ) E | (suc ฯ *แถ) Eโฒ | (suc ฯ *แถแถโฃ) EโฃEโฒ
   ... | _ | _ | suc-ฯ*EโฃEโฒ rewrite แดฟ+-comm 1 ฯ a | แดฟ+-comm 1 ฯ aโฒ = ฮฝแถแถ suc-ฯ*EโฃEโฒ
   (ฯ *แถแถโฃโ) (! EโฃEโฒ) = ! (ฯ *แถแถโฃ) EโฃEโฒ
