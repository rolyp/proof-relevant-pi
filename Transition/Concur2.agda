module Transition.Concur2 where

   open import SharedModules hiding ([_])

   open import Ext

   open import Action as แดฌ
      using (Action; Actionแต; Actionแถ; _แต; _แถ; inc; _แดฌโฃ_; แดฌโฃ-sym; แดฌโฃ-sym-involutive; แดบinc-inc);
      open แดฌ.Actionแต; open แดฌ.Actionแถ; open แดฌ._แดฌโฃ_
   import Action.Ren
   open import Name as แดบ using (Name; Cxt; module Cxt; zero; _+_; toโ)
   open import Ren as แดฟ using (Ren; Renameable; แดบren; suc; push; pop; swap); open แดฟ.Renameable โฆ...โฆ
   open import Ren.Properties
   open import Proc as แดพ using (Proc); open แดพ.Proc
   import Proc.Ren
   open import Transition as แต using (_โ[_-_]โ_; target); open แต._โ[_-_]โ_
   open import Transition.Ren using (_*แต; _*แถ)

   -- Second component here abstracts over the two action constructors.
   แดฌฮ : โ {ฮ} {a aโฒ : Action ฮ} โ a แดฌโฃ aโฒ โ ฮฃ[ A โ Set ] (A โ Action (ฮ + inc a))
   แดฌฮ {ฮ} แตโแต = Actionแถ (ฮ + 1) , _แถ
   แดฌฮ {ฮ} แตโแต = Actionแต (ฮ + 1) , _แต
   แดฌฮ {ฮ} แตโแถ = Actionแถ (ฮ + 1) , _แถ
   แดฌฮ {ฮ} แถโแต = Actionแต ฮ , _แต
   แดฌฮ {ฮ} แถโแถ = Actionแถ ฮ , _แถ

   -- The residual aโฒ/a. Note that แตโแต may also relate two bound outputs, but only if they represent
   -- extrusions of distinct binders.
   แดฌ/ : โ {ฮ} {a aโฒ : Action ฮ} (aโฃaโฒ : a แดฌโฃ aโฒ) โ ฯโ (แดฌฮ aโฃaโฒ)
   แดฌ/ (แตโแต {u = u}) = โข แดบ.suc u โฉ zero โช
   แดฌ/ (แตโแต {aโฒ = aโฒ}) = (push *) aโฒ
   แดฌ/ (แตโแถ {aโฒ = aโฒ}) = (push *) aโฒ
   แดฌ/ (แถโแต {aโฒ = aโฒ}) = aโฒ
   แดฌ/ (แถโแถ {aโฒ = aโฒ}) = aโฒ

   -- Symmetrise.
   แดฌโ : โ {ฮ} {a aโฒ : Action ฮ} (aโฃaโฒ : a แดฌโฃ aโฒ) โ Action (ฮ + inc a) ร Action (ฮ + inc aโฒ)
   แดฌโ aโฃaโฒ = ฯโ (แดฌฮ aโฃaโฒ) (แดฌ/ aโฃaโฒ) , ฯโ (แดฌฮ (แดฌโฃ-sym aโฃaโฒ)) (แดฌ/ (แดฌโฃ-sym aโฃaโฒ))

   -- A pair of composable actions.
   Actionโ : Cxt โ Set
   Actionโ ฮ = ฮฃ[ a โ Action ฮ ] Action (ฮ + inc a)

   incโ : โ {ฮ} โ Actionโ ฮ โ Cxt
   incโ (a , aโฒ) = inc a + inc aโฒ

   incโ-def : โ {ฮ} {a aโฒ : Action ฮ} (aโฃaโฒ : a แดฌโฃ aโฒ) โ ฮ + incโ (a , ฯโ (แดฌโ aโฃaโฒ)) โก ฮ + inc a + inc (ฯโ (แดฌโ aโฃaโฒ))
   incโ-def แตโแต = refl
   incโ-def แตโแต = refl
   incโ-def แตโแถ = refl
   incโ-def แถโแต = refl
   incโ-def แถโแถ = refl

   -- Cofinality of action residuals is simply agreement on target context.
   แดฌโ-โ : โ {ฮ} {a aโฒ : Action ฮ} (aโฃaโฒ : a แดฌโฃ aโฒ) โ ฮ + inc a + inc (ฯโ (แดฌโ aโฃaโฒ)) โก ฮ + inc aโฒ + inc (ฯโ (แดฌโ aโฃaโฒ))
   แดฌโ-โ แตโแต = refl
   แดฌโ-โ แตโแต = refl
   แดฌโ-โ แตโแถ = refl
   แดฌโ-โ แถโแต = refl
   แดฌโ-โ แถโแถ = refl

   -- Whether two coinitial evaluation contexts are concurrent; define symmetric reduction and then close under
   -- symmetry. Convenient to have this indexed by the kind of action residual. TODO: cases for โขโ and แตฅโ.
   syntax Concur E Eโฒ aโฃaโฒ = E โฃ[ aโฃaโฒ ] Eโฒ
   syntax Concurโ E Eโฒ aโฒ/a = E โฃโ[ aโฒ/a ] Eโฒ
   infix 4 Concurโ

   data Concur {ฮ} : โ {a aโฒ : Action ฮ} {P R Rโฒ} (E : P โ[ a - _ ]โ R) (Eโฒ : P โ[ aโฒ - _ ]โ Rโฒ) โ a แดฌโฃ aโฒ โ Set
   data Concurโ {ฮ} : โ {a aโฒ : Action ฮ} {P R Rโฒ} โ P โ[ a - _ ]โ R โ P โ[ aโฒ - _ ]โ Rโฒ โ a แดฌโฃ aโฒ โ Set

   data Concur {ฮ} where
      [_] : โ {a aโฒ : Action ฮ} {P R Rโฒ} {E : P โ[ a - _ ]โ R} {Eโฒ : P โ[ aโฒ - _ ]โ Rโฒ} {aโฃaโฒ : a แดฌโฃ aโฒ} โ
            E โฃโ[ aโฃaโฒ ] Eโฒ โ E โฃ[ aโฃaโฒ ] Eโฒ
      [_]หก : โ {a aโฒ : Action ฮ} {P R Rโฒ} {E : P โ[ a - _ ]โ R} {Eโฒ : P โ[ aโฒ - _ ]โ Rโฒ} {aโฃaโฒ : a แดฌโฃ aโฒ} โ
            E โฃโ[ aโฃaโฒ ] Eโฒ โ Eโฒ โฃ[ แดฌโฃ-sym aโฃaโฒ ] E

   data Concurโ {ฮ} where
      _แตโแต_ : โ {P Q R S} {a aโฒ : Actionแต ฮ}
             (E : P โ[ a แต - _ ]โ R) (F : Q โ[ aโฒ แต - _ ]โ S) โ E แตโ Q โฃโ[ แตโแต ] P โแต F
      _แตโแถ_ : โ {P Q R S} {a : Actionแต ฮ} {aโฒ : Actionแถ ฮ}
             (E : P โ[ a แต - _ ]โ R) (F : Q โ[ aโฒ แถ - _ ]โ S) โ E แตโ Q โฃโ[ แตโแถ ] P โแถ F
      _แถโแต_ : โ {P Q R S} {a : Actionแถ ฮ} {aโฒ : Actionแต ฮ}  โ
             (E : P โ[ a แถ - _ ]โ R) (F : Q โ[ aโฒ แต - _ ]โ S) โ E แถโ Q โฃโ[ แถโแต ] P โแต F
      _แถโแถ_ : โ {P Q R S} {a aโฒ : Actionแถ ฮ}  โ
             (E : P โ[ a แถ - _ ]โ R) (F : Q โ[ aโฒ แถ - _ ]โ S) โ E แถโ Q โฃโ[ แถโแถ ] P โแถ F
      -- โแตโข might be a better naming convention here, and similarly for โแตแตฅ.
      _โโขแต_ : โ {x y P R Rโฒ S Q} {a : Actionแต ฮ} {E : P โ[ a แต - _ ]โ R} {Eโฒ : P โ[ x โข แต - _ ]โ Rโฒ} โ
              E โฃ[ แตโแต ] Eโฒ โ (F : Q โ[ โข x โฉ y โช แถ - _ ]โ S) โ E แตโ Q โฃโ[ แตโแถ ] Eโฒ โโข F
      _โโขแถ_ : โ {x y P R Rโฒ S Q} {a : Actionแถ ฮ} {E : P โ[ a แถ - _ ]โ R} {Eโฒ : P โ[ x โข แต - _ ]โ Rโฒ} โ
              E โฃ[ แถโแต ] Eโฒ โ (F : Q โ[ โข x โฉ y โช แถ - _ ]โ S) โ E แถโ Q โฃโ[ แถโแถ ] Eโฒ โโข F
      _แตโโข_ : โ {x y P Q R S Sโฒ} {a : Actionแต ฮ} {F : Q โ[ a แต - _ ]โ S} {Fโฒ : Q โ[ โข x โฉ y โช แถ - _ ]โ Sโฒ}
              (E : P โ[ x โข แต - _ ]โ R) โ F โฃ[ แตโแถ ] Fโฒ โ P โแต F โฃโ[ แตโแถ ] E โโข Fโฒ
      _แถโโข_ : โ {x y P Q R S Sโฒ} {a : Actionแถ ฮ} {F : Q โ[ a แถ - _ ]โ S} {Fโฒ : Q โ[ โข x โฉ y โช แถ - _ ]โ Sโฒ}
              (E : P โ[ x โข แต - _ ]โ R) โ F โฃ[ แถโแถ ] Fโฒ โ P โแถ F โฃโ[ แถโแถ ] E โโข Fโฒ
      _โแตฅแต_ : โ {x P R Rโฒ S Q} {a : Actionแต ฮ} {E : P โ[ a แต - _ ]โ R} {Eโฒ : P โ[ x โข แต - _ ]โ Rโฒ} โ
             E โฃ[ แตโแต ] Eโฒ โ (F : Q โ[ (โข x) แต - _ ]โ S) โ E แตโ Q โฃโ[ แตโแถ ] Eโฒ โแตฅ F
      _โแตฅแถ_ : โ {x P R Rโฒ S Q} {a : Actionแถ ฮ} {E : P โ[ a แถ - _ ]โ R} {Eโฒ : P โ[ x โข แต - _ ]โ Rโฒ} โ
              E โฃ[ แถโแต ] Eโฒ โ (F : Q โ[ (โข x) แต - _ ]โ S) โ E แถโ Q โฃโ[ แถโแถ ] Eโฒ โแตฅ F
      _แตโแตฅ_ : โ {x P Q R S Sโฒ} {a : Actionแต ฮ} {aโฃaโฒ} {F : Q โ[ a แต - _ ]โ S} {Fโฒ : Q โ[ (โข x) แต - _ ]โ Sโฒ} โ
             (E : P โ[ x โข แต - _ ]โ R) โ F โฃ[ aโฃaโฒ ] Fโฒ โ P โแต F โฃโ[ แตโแถ ] E โแตฅ Fโฒ
      _แถโแตฅ_ : โ {x P Q R S Sโฒ} {a : Actionแถ ฮ} {F : Q โ[ a แถ - _ ]โ S} {Fโฒ : Q โ[ (โข x) แต - _ ]โ Sโฒ} โ
             (E : P โ[ x โข แต - _ ]โ R) โ F โฃ[ แถโแต ] Fโฒ โ P โแถ F โฃโ[ แถโแถ ] E โแตฅ Fโฒ
      _โโ_ : โ {P} {a : Action ฮ} {aโฒ : Action ฮ} {aโฃaโฒ} {R Rโฒ} {E : P โ[ a - _ ]โ R} {Eโฒ : P โ[ aโฒ - _ ]โ Rโฒ} โ
             E โฃ[ aโฃaโฒ ] Eโฒ โ (Q : Proc ฮ) โ E โโ Q โฃโ[ aโฃaโฒ ] Eโฒ โโ Q
      _โแตแต_ : โ {Q S Sโฒ} {a aโฒ : Actionแต ฮ} {aโฃaโฒ} {F : Q โ[ a แต - _ ]โ S} {Fโฒ : Q โ[ aโฒ แต - _ ]โ Sโฒ} โ
             (P : Proc ฮ) โ F โฃ[ aโฃaโฒ ] Fโฒ โ P โแต F โฃโ[ aโฃaโฒ ] P โแต Fโฒ
      _โแตแถ_ : โ {Q S Sโฒ} {a : Actionแต ฮ} {aโฒ : Actionแถ ฮ} {F : Q โ[ a แต - _ ]โ S} {Fโฒ : Q โ[ aโฒ แถ - _ ]โ Sโฒ} โ
             (P : Proc ฮ) โ F โฃ[ แตโแถ ] Fโฒ โ P โแต F โฃโ[ แตโแถ ] P โแถ Fโฒ
      _โแถแถ_ : โ {Q S Sโฒ} {a aโฒ : Actionแถ ฮ} {F : Q โ[ a แถ - _ ]โ S} {Fโฒ : Q โ[ aโฒ แถ - _ ]โ Sโฒ} โ
             (P : Proc ฮ) โ F โฃ[ แถโแถ ] Fโฒ โ P โแถ F โฃโ[ แถโแถ ] P โแถ Fโฒ
      _แตแตโ_ : โ {P R Rโฒ} {a aโฒ : Actionแต ฮ} {aโฃaโฒ} {E : P โ[ a แต - _ ]โ R} {Eโฒ : P โ[ aโฒ แต - _ ]โ Rโฒ} โ
              E โฃ[ aโฃaโฒ ] Eโฒ โ (Q : Proc ฮ) โ E แตโ Q โฃโ[ aโฃaโฒ ] Eโฒ แตโ Q
      _แตแถโ_ : โ {P R Rโฒ} {a : Actionแต ฮ} {aโฒ : Actionแถ ฮ} {E : P โ[ a แต - _ ]โ R} {Eโฒ : P โ[ aโฒ แถ - _ ]โ Rโฒ} โ
              E โฃ[ แตโแถ ] Eโฒ โ (Q : Proc ฮ) โ E แตโ Q โฃโ[ แตโแถ ] Eโฒ แถโ Q
      _แถแถโ_ : โ {P R Rโฒ} {a aโฒ : Actionแถ ฮ} {E : P โ[ a แถ - _ ]โ R} {Eโฒ : P โ[ aโฒ แถ - _ ]โ Rโฒ} โ
              E โฃ[ แถโแถ ] Eโฒ โ (Q : Proc ฮ) โ E แถโ Q โฃโ[ แถโแถ ] Eโฒ แถโ Q
      _โโข_ : โ {x y u z P Q R Rโฒ S Sโฒ} {E : P โ[ x โข แต - _ ]โ R} {Eโฒ : P โ[ u โข แต - _ ]โ Rโฒ}
             {F : Q โ[ โข x โฉ y โช แถ - _ ]โ S} {Fโฒ : Q โ[ โข u โฉ z โช แถ - _ ]โ Sโฒ} โ
             E โฃ[ แตโแต ] Eโฒ โ F โฃ[ แถโแถ ] Fโฒ โ E โโข F โฃโ[ แถโแถ ] Eโฒ โโข Fโฒ
      _โแตฅโข_ : โ {x u y P Q R Rโฒ S Sโฒ} {E : P โ[ x โข แต - _ ]โ R} {Eโฒ : P โ[ u โข แต - _ ]โ Rโฒ}
             {F : Q โ[ (โข x) แต - _ ]โ S} {Fโฒ : Q โ[ โข u โฉ y โช แถ - _ ]โ Sโฒ} โ
             E โฃ[ แตโแต ] Eโฒ โ F โฃ[ แตโแถ ] Fโฒ โ E โแตฅ F โฃโ[ แถโแถ ] Eโฒ โโข Fโฒ
      _โแตฅ_ : โ {x u P Q R Rโฒ S Sโฒ} {E : P โ[ x โข แต - _ ]โ R} {Eโฒ : P โ[ u โข แต - _ ]โ Rโฒ}
             {โขxโฃโขu} {F : Q โ[ (โข x) แต - _ ]โ S} {Fโฒ : Q โ[ (โข u) แต - _ ]โ Sโฒ} โ
             E โฃ[ แตโแต ] Eโฒ โ F โฃ[ โขxโฃโขu ] Fโฒ โ E โแตฅ F โฃโ[ แถโแถ ] Eโฒ โแตฅ Fโฒ
      ฮฝโข_ : โ {x u P R Rโฒ} {E : P โ[ โข แดบ.suc x โฉ zero โช แถ - _ ]โ R} {Eโฒ : P โ[ โข แดบ.suc u โฉ zero โช แถ - _ ]โ Rโฒ} โ
            E โฃ[ แถโแถ ] Eโฒ โ ฮฝโข E โฃโ[ แตโแต ] ฮฝโข Eโฒ
      ฮฝโขแต_ : โ {x P R Rโฒ} {a : Actionแต ฮ} {E : P โ[ โข แดบ.suc x โฉ zero โช แถ - _ ]โ R} {Eโฒ : P โ[ (push *) a แต - _ ]โ Rโฒ} โ
            E โฃ[ แถโแต ] Eโฒ โ ฮฝโข E โฃโ[ แตโแต ] ฮฝแต Eโฒ
      ฮฝโขแถ_ : โ {x P R Rโฒ} {a : Actionแถ ฮ} {E : P โ[ โข แดบ.suc x โฉ zero โช แถ - _ ]โ R} {Eโฒ : P โ[ (push *) a แถ - _ ]โ Rโฒ} โ
            E โฃ[ แถโแถ ] Eโฒ โ ฮฝโข E โฃโ[ แตโแถ ] ฮฝแถ Eโฒ
      ฮฝแตแต_ : โ {P R Rโฒ} {a aโฒ : Actionแต ฮ} {E : P โ[ (push *) a แต - _ ]โ R} {Eโฒ : P โ[ (push *) aโฒ แต - _ ]โ Rโฒ} โ
          E โฃ[ แตโแต ] Eโฒ โ ฮฝแต E โฃโ[ แตโแต ] ฮฝแต Eโฒ
      ฮฝแตแต_ : โ {P R Rโฒ} {x u : Name ฮ} {E : P โ[ (โข (push *) x) แต - _ ]โ R} {Eโฒ : P โ[ (โข (push *) u) แต - _ ]โ Rโฒ} โ
          E โฃ[ แตโแต ] Eโฒ โ ฮฝแต E โฃโ[ แตโแต ] ฮฝแต Eโฒ
      ฮฝแตแถ_ : โ {P R Rโฒ} {a : Actionแต ฮ} {aโฒ : Actionแถ ฮ} {E : P โ[ (push *) a แต - _ ]โ R} {Eโฒ : P โ[ (push *) aโฒ แถ - _ ]โ Rโฒ} โ
          E โฃ[ แตโแถ ] Eโฒ โ ฮฝแต E โฃโ[ แตโแถ ] ฮฝแถ Eโฒ
      ฮฝแถแถ_ : โ {P R Rโฒ} {a aโฒ : Actionแถ ฮ} {E : P โ[ (push *) a แถ - _ ]โ R} {Eโฒ : P โ[ (push *) aโฒ แถ - _ ]โ Rโฒ} โ
          E โฃ[ แถโแถ ] Eโฒ โ ฮฝแถ E โฃโ[ แถโแถ ] ฮฝแถ Eโฒ
      !_ : โ {P} {a : Action ฮ} {aโฒ : Action ฮ} {aโฃaโฒ} {R Rโฒ} {E : P โ ! P โ[ a - _ ]โ R} {Eโฒ : P โ ! P โ[ aโฒ - _ ]โ Rโฒ} โ
           E โฃ[ aโฃaโฒ ] Eโฒ โ ! E โฃโ[ aโฃaโฒ ] ! Eโฒ

   -- Flip the bit which says which way around to read the constructor.
   โฃ-sym : โ {ฮ} {a aโฒ : Action ฮ} {P R Rโฒ} {E : P โ[ a - _ ]โ R} {Eโฒ : P โ[ aโฒ - _ ]โ Rโฒ} {aโฃaโฒ : a แดฌโฃ aโฒ} โ
           E โฃ[ aโฃaโฒ ] Eโฒ โ Eโฒ โฃ[ แดฌโฃ-sym aโฃaโฒ ] E
   โฃ-sym [ ๐ธ ] = [ ๐ธ ]หก
   โฃ-sym [ ๐ธ ]หก = [ subst (Concurโ _ _) (sym (แดฌโฃ-sym-involutive _)) ๐ธ ]

   -- The type of the symmetric residual of concurrent transitions E and Eโฒ. Because cofinality of action
   -- residuals isn't baked in, need to coerce targets of E/Eโฒ and Eโฒ/E to the same type.
   record Deltaโฒ {ฮ P} {a aโฒ : Action ฮ} (aโฃaโฒ : a แดฌโฃ aโฒ) {R Rโฒ}
                (E : P โ[ a - _ ]โ R) (Eโฒ : P โ[ aโฒ - _ ]โ Rโฒ) : Set where
      constructor Delta
      aโฒ/a = ฯโ (แดฌโ aโฃaโฒ)
      a/aโฒ = ฯโ (แดฌโ aโฃaโฒ)
      ฮโฒ = ฮ + incโ (a , aโฒ/a)
      field
         {S Sโฒ} : Proc ฮโฒ
         Eโฒ/E : R โ[ aโฒ/a - _ ]โ subst Proc (incโ-def aโฃaโฒ) S
         E/Eโฒ : Rโฒ โ[ a/aโฒ - _ ]โ subst Proc (trans (incโ-def aโฃaโฒ) (แดฌโ-โ aโฃaโฒ)) Sโฒ

   infixl 5 Delta
   syntax Delta E Eโฒ = E แตฮ Eโฒ
   syntax Deltaโฒ aโฃaโฒ E Eโฒ = E ฮโฒ[ aโฃaโฒ ] Eโฒ

   open import Ren.Properties
   open Deltaโฒ

   -- The symmetric residual (Eโฒ/E , E/Eโฒ). The paper defines the residual using E and Eโฒ, with E โฃ Eโฒ
   -- implicit; here we work directly with the proof of E โฃ Eโฒ and leave E and Eโฒ implicit.
   โโ : โ {ฮ P} {a aโฒ : Action ฮ} {aโฃaโฒ : a แดฌโฃ aโฒ} {R Rโฒ} {E : P โ[ a - _ ]โ R} {Eโฒ : P โ[ aโฒ - _ ]โ Rโฒ} โ
        E โฃโ[ aโฃaโฒ ] Eโฒ โ E ฮโฒ[ aโฃaโฒ ] Eโฒ
   โ : โ {ฮ P} {a aโฒ : Action ฮ} {aโฃaโฒ : a แดฌโฃ aโฒ} {R Rโฒ} {E : P โ[ a - _ ]โ R} {Eโฒ : P โ[ aโฒ - _ ]โ Rโฒ} โ
       E โฃ[ aโฃaโฒ ] Eโฒ โ E ฮโฒ[ aโฃaโฒ ] Eโฒ

   โโ (E แตโแต F) = target E โแต (push *แต) F แตฮ (push *แต) E แตโ target F
   โโ (E แตโแถ F) = target E โแถ (push *แถ) F แตฮ E แตโ target F
   โโ (E แถโแต F) = target E โแต F แตฮ (push *แถ) E แถโ target F
   โโ (E แถโแถ F) = target E โแถ F แตฮ E แถโ target F
   โโ (_โโขแต_ {y = y} {a = a} ๐ธ F) with (pop y *แต) (E/Eโฒ (โ ๐ธ))
   ... | pop-y*E/Eโฒ rewrite popโpush y a = Eโฒ/E (โ ๐ธ) โโข (push *แถ) F แตฮ pop-y*E/Eโฒ แตโ target F
   โโ (_โโขแถ_ {y = y} {a = a} ๐ธ F) with (pop y *แถ) (E/Eโฒ (โ ๐ธ))
   ... | pop-y*E/Eโฒ rewrite popโpush y a = Eโฒ/E (โ ๐ธ) โโข F แตฮ pop-y*E/Eโฒ แถโ target F
   โโ (_แตโโข_ {y = y} E ๐น) = (push *แต) E แต.โโข Eโฒ/E (โ ๐น) แตฮ (pop y *) (target E) โแต E/Eโฒ (โ ๐น)
   โโ (_แถโโข_ {y = y} E ๐น) = E โโข Eโฒ/E (โ ๐น) แตฮ (pop y *) (target E) โแถ E/Eโฒ (โ ๐น)
   โโ (๐ธ โแตฅแต F) = Eโฒ/E (โ ๐ธ) โแตฅ (push *แต) F แตฮ ฮฝแต (E/Eโฒ (โ ๐ธ) แตโ target F)
   โโ (๐ธ โแตฅแถ F) = Eโฒ/E (โ ๐ธ) โแตฅ F แตฮ ฮฝแถ (E/Eโฒ (โ ๐ธ) แถโ target F)
   โโ (_แตโแตฅ_ {aโฃaโฒ = แตโแต} E ๐น) with (push *แต) E
   ... | push*E = push*E โโข Eโฒ/E (โ ๐น) แตฮ ฮฝโข (target E โแถ E/Eโฒ (โ ๐น))
   โโ (_แตโแตฅ_ {aโฃaโฒ = แตโแต} E ๐น) = (push *แต) E โแตฅ Eโฒ/E (โ ๐น) แตฮ ฮฝแต (target E โแต E/Eโฒ (โ ๐น))
   โโ (E แถโแตฅ ๐น) = E โแตฅ Eโฒ/E (โ ๐น) แตฮ ฮฝแถ (target E โแถ E/Eโฒ (โ ๐น))
   โโ (_โแตแต_ {aโฃaโฒ = แตโแต} P ๐น) = (push *) P โแถ Eโฒ/E (โ ๐น) แตฮ (push *) P โแถ E/Eโฒ (โ ๐น)
   โโ (_โแตแต_ {aโฃaโฒ = แตโแต} P ๐น) = (push *) P โแต Eโฒ/E (โ ๐น) แตฮ (push *) P โแต E/Eโฒ (โ ๐น)
   โโ (P โแตแถ ๐น) = (push *) P โแถ Eโฒ/E (โ ๐น) แตฮ P โแต E/Eโฒ (โ ๐น)
   โโ (P โแถแถ ๐น) = P โแถ Eโฒ/E (โ ๐น) แตฮ P โแถ E/Eโฒ (โ ๐น)
   โโ (_แตแตโ_ {aโฃaโฒ = แตโแต} ๐ธ Q) = Eโฒ/E (โ ๐ธ) แถโ (push *) Q แตฮ E/Eโฒ (โ ๐ธ) แถโ (push *) Q
   โโ (_แตแตโ_ {aโฃaโฒ = แตโแต} ๐ธ Q) = Eโฒ/E (โ ๐ธ) แตโ (push *) Q แตฮ E/Eโฒ (โ ๐ธ) แตโ (push *) Q
   โโ (๐ธ แตแถโ Q) = Eโฒ/E (โ ๐ธ) แถโ (push *) Q แตฮ E/Eโฒ (โ ๐ธ) แตโ Q
   โโ (๐ธ แถแถโ Q) = Eโฒ/E (โ ๐ธ) แถโ Q แตฮ E/Eโฒ (โ ๐ธ) แถโ Q
   โโ (๐ธ โโ F) = Eโฒ/E (โ ๐ธ) แตฮ E/Eโฒ (โ ๐ธ)
   โโ (_โโข_ {x = x} {y} {u} {z} ๐ธ ๐น) with (pop y *แต) (Eโฒ/E (โ ๐ธ)) | (pop z *แต) (E/Eโฒ (โ ๐ธ))
   ... | pop-y*Eโฒ/E | pop-z*E/Eโฒ rewrite popโpush u y | popโpush x z = pop-y*Eโฒ/E โโข Eโฒ/E (โ ๐น) แตฮ pop-z*E/Eโฒ โโข E/Eโฒ (โ ๐น)
   โโ (_โแตฅโข_ {x = x} {y = y} ๐ธ ๐น) with (pop y *แต) (E/Eโฒ (โ ๐ธ))
   ... | pop-y*E/Eโฒ rewrite popโpush x y = ฮฝแถ (Eโฒ/E (โ ๐ธ) โโข Eโฒ/E (โ ๐น)) แตฮ pop-y*E/Eโฒ โแตฅ E/Eโฒ (โ ๐น)
   โโ (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐น) = ฮฝแถ (Eโฒ/E (โ ๐ธ) โโข Eโฒ/E (โ ๐น)) แตฮ ฮฝแถ (E/Eโฒ (โ ๐ธ) โโข E/Eโฒ (โ ๐น))
   โโ (_โแตฅ_ {โขxโฃโขu = แตโแต} ๐ธ ๐น) = ฮฝแถ (Eโฒ/E (โ ๐ธ) โแตฅ Eโฒ/E (โ ๐น)) แตฮ ฮฝแถ (E/Eโฒ (โ ๐ธ) โแตฅ E/Eโฒ (โ ๐น))
   โโ (ฮฝโข ๐ธ) = Eโฒ/E (โ ๐ธ) แตฮ E/Eโฒ (โ ๐ธ)
   โโ (ฮฝโขแต_ {x = x} {a = a} ๐ธ) with (swap *แถ) (E/Eโฒ (โ ๐ธ))
   ... | swap*E/Eโฒ = Eโฒ/E (โ ๐ธ) แตฮ ฮฝโข swap*E/Eโฒ
   โโ (ฮฝโขแถ ๐ธ) = Eโฒ/E (โ ๐ธ) แตฮ ฮฝโข E/Eโฒ (โ ๐ธ)
   โโ (ฮฝแตแต_ {a = x โข} {a} ๐ธ) with (swap *แต) (E/Eโฒ (โ ๐ธ)) | (swap *แต) (Eโฒ/E (โ ๐ธ))
   ... | swap*E/Eโฒ | swap*Eโฒ/E rewrite swapโpushโpush x | swapโpushโpush a = ฮฝแต swap*Eโฒ/E แตฮ ฮฝแต swap*E/Eโฒ
   โโ (ฮฝแตแต_ {a = โข x} {u โข} ๐ธ) with (swap *แต) (E/Eโฒ (โ ๐ธ)) | (swap *แต) (Eโฒ/E (โ ๐ธ))
   ... | swap*E/Eโฒ | swap*Eโฒ/E rewrite swapโpushโpush x | swapโpushโpush u = ฮฝแต swap*Eโฒ/E แตฮ ฮฝแต swap*E/Eโฒ
   โโ (ฮฝแตแต_ {a = โข x} {โข u} ๐ธ) with (swap *แต) (E/Eโฒ (โ ๐ธ)) | (swap *แต) (Eโฒ/E (โ ๐ธ))
   ... | swap*E/Eโฒ | swap*Eโฒ/E = ฮฝแต swap*Eโฒ/E แตฮ ฮฝแต swap*E/Eโฒ
   โโ (ฮฝแตแต_ {x = x} {u} ๐ธ) with (swap *แถ) (E/Eโฒ (โ ๐ธ)) | (swap *แถ) (Eโฒ/E (โ ๐ธ))
   ... | swap*E/Eโฒ | swap*Eโฒ/E = ฮฝแถ swap*Eโฒ/E แตฮ ฮฝแถ swap*E/Eโฒ
   โโ (ฮฝแตแถ_ {aโฒ = aโฒ} ๐ธ) with (swap *แถ) (Eโฒ/E (โ ๐ธ))
   ... | swap*Eโฒ/E rewrite swapโpushโpush aโฒ = ฮฝแถ swap*Eโฒ/E แตฮ ฮฝแต E/Eโฒ (โ ๐ธ)
   โโ (ฮฝแถแถ ๐ธ) = ฮฝแถ (Eโฒ/E (โ ๐ธ)) แตฮ ฮฝแถ (E/Eโฒ (โ ๐ธ))
   โโ (! ๐ธ) = Eโฒ/E (โ ๐ธ) แตฮ E/Eโฒ (โ ๐ธ)

   โ [ ๐ธ ] = โโ ๐ธ
   โ ([_]หก {aโฃaโฒ = แตโแต} ๐ธ) = E/Eโฒ (โโ ๐ธ) แตฮ Eโฒ/E (โโ ๐ธ)
   โ ([_]หก {aโฃaโฒ = แตโแต} ๐ธ) = E/Eโฒ (โโ ๐ธ) แตฮ Eโฒ/E (โโ ๐ธ)
   โ ([_]หก {aโฃaโฒ = แตโแถ} ๐ธ) = E/Eโฒ (โโ ๐ธ) แตฮ Eโฒ/E (โโ ๐ธ)
   โ ([_]หก {aโฃaโฒ = แถโแต} ๐ธ) = E/Eโฒ (โโ ๐ธ) แตฮ Eโฒ/E (โโ ๐ธ)
   โ ([_]หก {aโฃaโฒ = แถโแถ} ๐ธ) = E/Eโฒ (โโ ๐ธ) แตฮ Eโฒ/E (โโ ๐ธ)
