module Transition.Seq.Cofinal.Cofinal where

   open import SharedModules
   import Relation.Binary.EqReasoning as EqReasoning

   open import Action as á´¬ using (Action; inc); open á´¬.Action; open á´¬.Actionáµ‡; open á´¬.Actioná¶œ
   open import Action.Concur using (_á´¬âŒ£_; module _á´¬âŒ£_; á´¬âŠ–; á´¬Î”; á´¬/); open _á´¬âŒ£_
   open import Action.Seq as á´¬â‹† using (Actionâ‹†; incâ‹†)
   open import Braiding.Proc as á´® using (_â‹‰_; â‹ˆ-to-â‹‰; target)
   open import Braiding.Transition using (_Î”â¼_; _Î”_; âŠ–)
   open import Name as á´º using (Cxt; _+_; +-assoc; zero)
   open import Proc using (Proc; Procâ†±; Procâ†²)
   open import Ren as á´¿ using (suc; swap; _á´¿+_); open á´¿.Renameable â¦ƒ...â¦„
   open import Transition.Concur.Cofinal using (ï¹™_,_,_,_ï¹š; âŠ–-âœ“)
   open import Transition.Concur.Cofinal.Transition using (âŠ–â€²[_,_]; _Î”_; braid)
   open import Transition.Seq as áµ€â‹† using (_â€”[_]â†’â‹†_; sourceâ‹†; targetâ‹†); open áµ€â‹†._â€”[_]â†’â‹†_
   open import Transition.Seq.Cofinal using (_Î”â‹†_; module _Î”â‹†_; _Î”_; âŠ–â‹†[_,_])

   -- Painful exercise in heterogeneous equality. TODO: consolidate Ë£âˆ‡Ë£, áµ‡âˆ‡á¶œ and á¶œâˆ‡áµ‡ cases, which are identical.
   âŠ–â‹†-âœ“ : âˆ€ {Î“} {a aâ€² : Action Î“} (ğ‘ : a á´¬âŒ£ aâ€²) Î”â€² {P Pâ€² : Proc (Î“ + inc a + inc (Ï€â‚ (á´¬âŠ– ğ‘)) + Î”â€²)} {aâ‹† R}
          (Eâ‹† : P â€”[ aâ‹† ]â†’â‹† R) (Î³ : ï¹™ _â‹‰_ , Î“ , ğ‘ , Î”â€² ï¹š P Pâ€²) â†’ let open _Î”â‹†_ in S (âŠ–â‹†[ ğ‘ , Î”â€² ] Eâ‹† Î³) â‰… Sâ€² (âŠ–â‹†[ ğ‘ , Î”â€² ] Eâ‹† Î³)
   âŠ–â‹†-âœ“ Ë£âˆ‡Ë£ _ [] _ = â‰…-refl
   âŠ–â‹†-âœ“ {Î“} (Ë£âˆ‡Ë£ {x = x} {u}) Î”â€² {aâ‹† = _ á´¬â‹†.áµ‡âˆ· aâ‹†} (E áµ‡âˆ· Eâ‹†) refl with âŠ–â€²[ Ë£âˆ‡Ë£ {x = x} {u} , Î”â€² ] E refl
   ... | refl Î” E/Î³ with âŠ–â‹†[ Ë£âˆ‡Ë£ {x = x} {u} , Î”â€² + 1 ] Eâ‹† refl | âŠ–â‹†-âœ“ (Ë£âˆ‡Ë£ {x = x} {u}) (Î”â€² + 1) Eâ‹† refl
   ... | _Î”_ {._} refl Eâ‹†/Î³/E | âŠ–â‹†-âœ“â€² =
      let open â‰…-Reasoning; Î“â€² = incâ‹† aâ‹† in
      begin
         Procâ†± (+-assoc (Î“ + 1) Î”â€² (1 + Î“â€²)) (Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 1 Î“â€²) (targetâ‹† Eâ‹†))
      â‰…âŸ¨ Procâ†² (+-assoc (Î“ + 1) Î”â€² (1 + Î“â€²)) _ âŸ©
         Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 1 Î“â€²) (targetâ‹† Eâ‹†)
      â‰…âŸ¨ Procâ†² (+-assoc (Î“ + 1 + Î”â€²) 1 Î“â€²) _ âŸ©
         targetâ‹† Eâ‹†
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + 1) (Î”â€² + 1) Î“â€²) _) âŸ©
         Procâ†± (+-assoc (Î“ + 1) (Î”â€² + 1) Î“â€²) (targetâ‹† Eâ‹†)
      â‰…âŸ¨ âŠ–â‹†-âœ“â€² âŸ©
         targetâ‹† Eâ‹†/Î³/E
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + 1 + Î”â€²) 1 Î“â€²) _) âŸ©
         Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 1 Î“â€²) (targetâ‹† Eâ‹†/Î³/E)
      âˆ
   âŠ–â‹†-âœ“ {Î“} (Ë£âˆ‡Ë£ {x = x} {u}) Î”â€² {aâ‹† = _ á´¬â‹†.á¶œâˆ· aâ‹†} (E á¶œâˆ· Eâ‹†) refl with âŠ–â€²[ Ë£âˆ‡Ë£ {x = x} {u} , Î”â€² ] E refl
   ... | refl Î” E/Î³ with âŠ–â‹†[ Ë£âˆ‡Ë£ {x = x} {u} , Î”â€² ] Eâ‹† refl | âŠ–â‹†-âœ“ (Ë£âˆ‡Ë£ {x = x} {u}) Î”â€² Eâ‹† refl
   ... | _Î”_ {._} refl Eâ‹†/Î³/E | âŠ–â‹†-âœ“â€² =
      let open â‰…-Reasoning; Î“â€² = incâ‹† aâ‹† in
      begin
         Procâ†± (+-assoc (Î“ + 1) Î”â€² (0 + Î“â€²)) (Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 0 Î“â€²) (targetâ‹† Eâ‹†))
      â‰…âŸ¨ Procâ†² (+-assoc (Î“ + 1) Î”â€² (0 + Î“â€²)) _ âŸ©
         Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 0 Î“â€²) (targetâ‹† Eâ‹†)
      â‰…âŸ¨ Procâ†² (+-assoc (Î“ + 1 + Î”â€²) 0 Î“â€²) _ âŸ©
         targetâ‹† Eâ‹†
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + 1) (Î”â€² + 0) Î“â€²) _) âŸ©
         Procâ†± (+-assoc (Î“ + 1) (Î”â€² + 0) Î“â€²) (targetâ‹† Eâ‹†)
      â‰…âŸ¨ âŠ–â‹†-âœ“â€² âŸ©
         targetâ‹† Eâ‹†/Î³/E
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + 1 + Î”â€²) 0 Î“â€²) _) âŸ©
         Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 0 Î“â€²) (targetâ‹† Eâ‹†/Î³/E)
      âˆ
   âŠ–â‹†-âœ“ áµ‡âˆ‡áµ‡ _ [] _ = â‰…-refl
   âŠ–â‹†-âœ“ {Î“} (áµ‡âˆ‡áµ‡ {a = a} {aâ€²}) Î”â€² {aâ‹† = _ á´¬â‹†.áµ‡âˆ· aâ‹†} (E áµ‡âˆ· Eâ‹†) refl with âŠ–â€²[ áµ‡âˆ‡áµ‡ {a = a} {aâ€²} , Î”â€² ] E refl
   ... | refl Î” E/Î³ with âŠ–â‹†[ áµ‡âˆ‡áµ‡ {a = a} {aâ€²} , Î”â€² + 1 ] Eâ‹† refl | âŠ–â‹†-âœ“ (áµ‡âˆ‡áµ‡ {a = a} {aâ€²}) (Î”â€² + 1) Eâ‹† refl
   ... | _Î”_ {._} refl Eâ‹†/Î³/E | âŠ–â‹†-âœ“â€² =
      let open â‰…-Reasoning; Î“â€² = incâ‹† aâ‹†
          â‰…-cong-swap : âˆ€ {Î”â€² Î”â€³ : Cxt} {P : Proc (Î“ + 2 + Î”â€²)} {Pâ€² : Proc (Î“ + 2 + Î”â€³)} â†’
                      Î”â€² â‰¡ Î”â€³ â†’ P â‰… Pâ€² â†’ ((swap á´¿+ Î”â€²) *) P â‰… ((swap á´¿+ Î”â€³) *) Pâ€²
          â‰…-cong-swap = Î» { {Î”â€² = _} refl â‰…-refl â†’ â‰…-refl } in
      begin
         ((swap á´¿+ (Î”â€² + (1 + Î“â€²))) *)
         (Procâ†± (+-assoc (Î“ + 2) Î”â€² (1 + Î“â€²)) (Procâ†± (+-assoc (Î“ + 2 + Î”â€²) 1 Î“â€²) (targetâ‹† Eâ‹†)))
      â‰…âŸ¨ â‰…-cong-swap (sym (+-assoc Î”â€² 1 Î“â€²))
         (begin
            Procâ†± (+-assoc (Î“ + 2) Î”â€² (1 + Î“â€²)) (Procâ†± (+-assoc (Î“ + 2 + Î”â€²) 1 Î“â€²) (targetâ‹† Eâ‹†))
         â‰…âŸ¨ Procâ†² (+-assoc (Î“ + 2) Î”â€² (1 + Î“â€²)) _ âŸ©
            Procâ†± (+-assoc (Î“ + 2 + Î”â€²) 1 Î“â€²) (targetâ‹† Eâ‹†)
         â‰…âŸ¨ Procâ†² (+-assoc (Î“ + 2 + Î”â€²) 1 Î“â€²) _ âŸ©
            targetâ‹† Eâ‹†
         â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + 2) (Î”â€² + 1) Î“â€²) _) âŸ©
            Procâ†± (+-assoc (Î“ + 2) (Î”â€² + 1) Î“â€²) (targetâ‹† Eâ‹†)
         âˆ) âŸ©
         ((swap á´¿+ (Î”â€² + 1 + Î“â€²)) *) (Procâ†± (+-assoc (Î“ + 2) (Î”â€² + 1) Î“â€²) (targetâ‹† Eâ‹†))
      â‰…âŸ¨ âŠ–â‹†-âœ“â€² âŸ©
         targetâ‹† Eâ‹†/Î³/E
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + 2 + Î”â€²) 1 (incâ‹† ((suc (swap á´¿+ Î”â€²) *) aâ‹†))) _) âŸ©
         Procâ†± (+-assoc (Î“ + 2 + Î”â€²) 1 (incâ‹† ((suc (swap á´¿+ Î”â€²) *) aâ‹†))) (targetâ‹† Eâ‹†/Î³/E)
      âˆ
   âŠ–â‹†-âœ“ {Î“} (áµ‡âˆ‡áµ‡ {a = a} {aâ€²}) Î”â€² {aâ‹† = _ á´¬â‹†.á¶œâˆ· aâ‹†} (E á¶œâˆ· Eâ‹†) refl with âŠ–â€²[ áµ‡âˆ‡áµ‡ {a = a} {aâ€²} , Î”â€² ] E refl
   ... | refl Î” E/Î³ with âŠ–â‹†[ áµ‡âˆ‡áµ‡ {a = a} {aâ€²} , Î”â€² ] Eâ‹† refl | âŠ–â‹†-âœ“ (áµ‡âˆ‡áµ‡ {a = a} {aâ€²}) Î”â€² Eâ‹† refl
   ... | _Î”_ {._} refl Eâ‹†/Î³/E | âŠ–â‹†-âœ“â€² =
      let open â‰…-Reasoning; Î“â€² = incâ‹† aâ‹† in
      begin
         ((swap á´¿+ (Î”â€² + (0 + Î“â€²))) *)
         (Procâ†± (+-assoc (Î“ + 2) Î”â€² (0 + Î“â€²)) (Procâ†± (+-assoc (Î“ + 2 + Î”â€²) 0 Î“â€²) (targetâ‹† Eâ‹†)))
      â‰…âŸ¨ {!!} âŸ©
         ((swap á´¿+ (Î”â€² + 0 + Î“â€²)) *) (Procâ†± (+-assoc (Î“ + 2) (Î”â€² + 0) Î“â€²) (targetâ‹† Eâ‹†))
      â‰…âŸ¨ âŠ–â‹†-âœ“â€² âŸ©
         targetâ‹† Eâ‹†/Î³/E
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + 2 + Î”â€²) 0 (incâ‹† (((swap á´¿+ Î”â€²) *) aâ‹†))) _) âŸ©
         Procâ†± (+-assoc (Î“ + 2 + Î”â€²) 0 (incâ‹† (((swap á´¿+ Î”â€²) *) aâ‹†))) (targetâ‹† Eâ‹†/Î³/E)
      âˆ
   âŠ–â‹†-âœ“ áµ‡âˆ‡á¶œ _ [] _ = â‰…-refl
   âŠ–â‹†-âœ“ {Î“} (áµ‡âˆ‡á¶œ {a = a} {aâ€²}) Î”â€² {aâ‹† = _ á´¬â‹†.áµ‡âˆ· aâ‹†} (E áµ‡âˆ· Eâ‹†) refl with âŠ–â€²[ áµ‡âˆ‡á¶œ {a = a} {aâ€²} , Î”â€² ] E refl
   ... | refl Î” E/Î³ with âŠ–â‹†[ áµ‡âˆ‡á¶œ {a = a} {aâ€²} , Î”â€² + 1 ] Eâ‹† refl | âŠ–â‹†-âœ“ (áµ‡âˆ‡á¶œ {a = a} {aâ€²}) (Î”â€² + 1) Eâ‹† refl
   ... | _Î”_ {._} refl Eâ‹†/Î³/E | âŠ–â‹†-âœ“â€² =
      let open â‰…-Reasoning; Î“â€² = incâ‹† aâ‹† in
      begin
         Procâ†± (+-assoc (Î“ + 1) Î”â€² (1 + Î“â€²)) (Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 1 Î“â€²) (targetâ‹† Eâ‹†))
      â‰…âŸ¨ Procâ†² (+-assoc (Î“ + 1) Î”â€² (1 + Î“â€²)) _ âŸ©
         Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 1 Î“â€²) (targetâ‹† Eâ‹†)
      â‰…âŸ¨ Procâ†² (+-assoc (Î“ + 1 + Î”â€²) 1 Î“â€²) _ âŸ©
         targetâ‹† Eâ‹†
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + 1) (Î”â€² + 1) Î“â€²) _) âŸ©
         Procâ†± (+-assoc (Î“ + 1) (Î”â€² + 1) Î“â€²) (targetâ‹† Eâ‹†)
      â‰…âŸ¨ âŠ–â‹†-âœ“â€² âŸ©
         targetâ‹† Eâ‹†/Î³/E
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + 1 + Î”â€²) 1 Î“â€²) _) âŸ©
         Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 1 Î“â€²) (targetâ‹† Eâ‹†/Î³/E)
      âˆ
   âŠ–â‹†-âœ“ {Î“} (áµ‡âˆ‡á¶œ {a = a} {aâ€²}) Î”â€² {aâ‹† = _ á´¬â‹†.á¶œâˆ· aâ‹†} (E á¶œâˆ· Eâ‹†) refl with âŠ–â€²[ áµ‡âˆ‡á¶œ {a = a} {aâ€²} , Î”â€² ] E refl
   ... | refl Î” E/Î³ with âŠ–â‹†[ áµ‡âˆ‡á¶œ {a = a} {aâ€²} , Î”â€² ] Eâ‹† refl | âŠ–â‹†-âœ“ (áµ‡âˆ‡á¶œ {a = a} {aâ€²}) Î”â€² Eâ‹† refl
   ... | _Î”_ {._} refl Eâ‹†/Î³/E | âŠ–â‹†-âœ“â€² =
      let open â‰…-Reasoning; Î“â€² = incâ‹† aâ‹† in
      begin
         Procâ†± (+-assoc (Î“ + 1) Î”â€² (0 + Î“â€²)) (Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 0 Î“â€²) (targetâ‹† Eâ‹†))
      â‰…âŸ¨ Procâ†² (+-assoc (Î“ + 1) Î”â€² (0 + Î“â€²)) _ âŸ©
         Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 0 Î“â€²) (targetâ‹† Eâ‹†)
      â‰…âŸ¨ Procâ†² (+-assoc (Î“ + 1 + Î”â€²) 0 Î“â€²) _ âŸ©
         targetâ‹† Eâ‹†
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + 1) (Î”â€² + 0) Î“â€²) _) âŸ©
         Procâ†± (+-assoc (Î“ + 1) (Î”â€² + 0) Î“â€²) (targetâ‹† Eâ‹†)
      â‰…âŸ¨ âŠ–â‹†-âœ“â€² âŸ©
         targetâ‹† Eâ‹†/Î³/E
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + 1 + Î”â€²) 0 Î“â€²) _) âŸ©
         Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 0 Î“â€²) (targetâ‹† Eâ‹†/Î³/E)
      âˆ
   âŠ–â‹†-âœ“ á¶œâˆ‡áµ‡ _ [] _ = â‰…-refl
   âŠ–â‹†-âœ“ {Î“} (á¶œâˆ‡áµ‡ {a = a} {aâ€²}) Î”â€² {aâ‹† = _ á´¬â‹†.áµ‡âˆ· aâ‹†} (E áµ‡âˆ· Eâ‹†) refl with âŠ–â€²[ á¶œâˆ‡áµ‡ {a = a} {aâ€²} , Î”â€² ] E refl
   ... | refl Î” E/Î³ with âŠ–â‹†[ á¶œâˆ‡áµ‡ {a = a} {aâ€²} , Î”â€² + 1 ] Eâ‹† refl | âŠ–â‹†-âœ“ (á¶œâˆ‡áµ‡ {a = a} {aâ€²}) (Î”â€² + 1) Eâ‹† refl
   ... | _Î”_ {._} refl Eâ‹†/Î³/E | âŠ–â‹†-âœ“â€² =
      let open â‰…-Reasoning; Î“â€² = incâ‹† aâ‹† in
      begin
         Procâ†± (+-assoc (Î“ + 1) Î”â€² (1 + Î“â€²)) (Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 1 Î“â€²) (targetâ‹† Eâ‹†))
      â‰…âŸ¨ Procâ†² (+-assoc (Î“ + 1) Î”â€² (1 + Î“â€²)) _ âŸ©
         Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 1 Î“â€²) (targetâ‹† Eâ‹†)
      â‰…âŸ¨ Procâ†² (+-assoc (Î“ + 1 + Î”â€²) 1 Î“â€²) _ âŸ©
         targetâ‹† Eâ‹†
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + 1) (Î”â€² + 1) Î“â€²) _) âŸ©
         Procâ†± (+-assoc (Î“ + 1) (Î”â€² + 1) Î“â€²) (targetâ‹† Eâ‹†)
      â‰…âŸ¨ âŠ–â‹†-âœ“â€² âŸ©
         targetâ‹† Eâ‹†/Î³/E
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + 1 + Î”â€²) 1 Î“â€²) _) âŸ©
         Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 1 Î“â€²) (targetâ‹† Eâ‹†/Î³/E)
      âˆ
   âŠ–â‹†-âœ“ {Î“} (á¶œâˆ‡áµ‡ {a = a} {aâ€²}) Î”â€² {aâ‹† = _ á´¬â‹†.á¶œâˆ· aâ‹†} (E á¶œâˆ· Eâ‹†) refl with âŠ–â€²[ á¶œâˆ‡áµ‡ {a = a} {aâ€²} , Î”â€² ] E refl
   ... | refl Î” E/Î³ with âŠ–â‹†[ á¶œâˆ‡áµ‡ {a = a} {aâ€²} , Î”â€² ] Eâ‹† refl | âŠ–â‹†-âœ“ (á¶œâˆ‡áµ‡ {a = a} {aâ€²}) Î”â€² Eâ‹† refl
   ... | _Î”_ {._} refl Eâ‹†/Î³/E | âŠ–â‹†-âœ“â€² =
      let open â‰…-Reasoning; Î“â€² = incâ‹† aâ‹† in
      begin
         Procâ†± (+-assoc (Î“ + 1) Î”â€² (0 + Î“â€²)) (Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 0 Î“â€²) (targetâ‹† Eâ‹†))
      â‰…âŸ¨ Procâ†² (+-assoc (Î“ + 1) Î”â€² (0 + Î“â€²)) _ âŸ©
         Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 0 Î“â€²) (targetâ‹† Eâ‹†)
      â‰…âŸ¨ Procâ†² (+-assoc (Î“ + 1 + Î”â€²) 0 Î“â€²) _ âŸ©
         targetâ‹† Eâ‹†
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + 1) (Î”â€² + 0) Î“â€²) _) âŸ©
         Procâ†± (+-assoc (Î“ + 1) (Î”â€² + 0) Î“â€²) (targetâ‹† Eâ‹†)
      â‰…âŸ¨ âŠ–â‹†-âœ“â€² âŸ©
         targetâ‹† Eâ‹†/Î³/E
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + 1 + Î”â€²) 0 Î“â€²) _) âŸ©
         Procâ†± (+-assoc (Î“ + 1 + Î”â€²) 0 Î“â€²) (targetâ‹† Eâ‹†/Î³/E)
      âˆ
   âŠ–â‹†-âœ“ á¶œâˆ‡á¶œ _ [] _ = â‰…-refl
   âŠ–â‹†-âœ“ {Î“} (á¶œâˆ‡á¶œ {a = a} {aâ€²}) Î”â€² {aâ‹† = _ á´¬â‹†.áµ‡âˆ· aâ‹†} (E áµ‡âˆ· Eâ‹†) refl with âŠ–â€²[ á¶œâˆ‡á¶œ {a = a} {aâ€²} , Î”â€² ] E refl
   ... | refl Î” E/Î³ with âŠ–â‹†[ á¶œâˆ‡á¶œ {a = a} {aâ€²} , Î”â€² + 1 ] Eâ‹† refl | âŠ–â‹†-âœ“ (á¶œâˆ‡á¶œ {a = a} {aâ€²}) (Î”â€² + 1) Eâ‹† refl
   ... | _Î”_ {._} refl Eâ‹†/Î³/E | âŠ–â‹†-âœ“â€² =
      let open â‰…-Reasoning; Î“â€² = incâ‹† aâ‹† in
      begin
         Procâ†± (+-assoc Î“ Î”â€² (1 + Î“â€²)) (Procâ†± (+-assoc (Î“ + Î”â€²) 1 Î“â€²) (targetâ‹† Eâ‹†))
      â‰…âŸ¨ Procâ†² (+-assoc Î“ Î”â€² (1 + Î“â€²)) _ âŸ©
         Procâ†± (+-assoc (Î“ + Î”â€²) 1 Î“â€²) (targetâ‹† Eâ‹†)
      â‰…âŸ¨ Procâ†² (+-assoc (Î“ + Î”â€²) 1 Î“â€²) _ âŸ©
         targetâ‹† Eâ‹†
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc Î“ (Î”â€² + 1) Î“â€²) _) âŸ©
         Procâ†± (+-assoc Î“ (Î”â€² + 1) Î“â€²) (targetâ‹† Eâ‹†)
      â‰…âŸ¨ âŠ–â‹†-âœ“â€² âŸ©
         targetâ‹† Eâ‹†/Î³/E
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + Î”â€²) 1 Î“â€²) _) âŸ©
         Procâ†± (+-assoc (Î“ + Î”â€²) 1 Î“â€²) (targetâ‹† Eâ‹†/Î³/E)
      âˆ
   âŠ–â‹†-âœ“ {Î“} (á¶œâˆ‡á¶œ {a = a} {aâ€²}) Î”â€² {aâ‹† = _ á´¬â‹†.á¶œâˆ· aâ‹†} (E á¶œâˆ· Eâ‹†) refl with âŠ–â€²[ á¶œâˆ‡á¶œ {a = a} {aâ€²} , Î”â€² ] E refl
   ... | refl Î” E/Î³ with âŠ–â‹†[ á¶œâˆ‡á¶œ {a = a} {aâ€²} , Î”â€² ] Eâ‹† refl | âŠ–â‹†-âœ“ (á¶œâˆ‡á¶œ {a = a} {aâ€²}) Î”â€² Eâ‹† refl
   ... | _Î”_ {._} refl Eâ‹†/Î³/E | âŠ–â‹†-âœ“â€² =
      let open â‰…-Reasoning; Î“â€² = incâ‹† aâ‹† in
      begin
         Procâ†± (+-assoc Î“ Î”â€² (0 + Î“â€²)) (Procâ†± (+-assoc (Î“ + Î”â€²) 0 Î“â€²) (targetâ‹† Eâ‹†))
      â‰…âŸ¨ Procâ†² (+-assoc Î“ Î”â€² (0 + Î“â€²)) _ âŸ©
         Procâ†± (+-assoc (Î“ + Î”â€²) 0 Î“â€²) (targetâ‹† Eâ‹†)
      â‰…âŸ¨ Procâ†² (+-assoc (Î“ + Î”â€²) 0 Î“â€²) _ âŸ©
         targetâ‹† Eâ‹†
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc Î“ (Î”â€² + 0) Î“â€²) _) âŸ©
         Procâ†± (+-assoc Î“ (Î”â€² + 0) Î“â€²) (targetâ‹† Eâ‹†)
      â‰…âŸ¨ âŠ–â‹†-âœ“â€² âŸ©
         targetâ‹† Eâ‹†/Î³/E
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + Î”â€²) 0 Î“â€²) _) âŸ©
         Procâ†± (+-assoc (Î“ + Î”â€²) 0 Î“â€²) (targetâ‹† Eâ‹†/Î³/E)
      âˆ
   âŠ–â‹†-âœ“ áµ›âˆ‡áµ› _ [] _ = â‰…-refl
   âŠ–â‹†-âœ“ {Î“} áµ›âˆ‡áµ› Î”â€² {aâ‹† = _ á´¬â‹†.áµ‡âˆ· aâ‹†} (E áµ‡âˆ· Eâ‹†) Ï† with âŠ– E Ï†
   ... | Ï†/E Î” E/Ï† with âŠ–â‹†[ áµ›âˆ‡áµ› , Î”â€² + 1 ] Eâ‹† Ï†/E | âŠ–â‹†-âœ“ áµ›âˆ‡áµ› (Î”â€² + 1) Eâ‹† Ï†/E
   ... | Ï†/E/Eâ‹† Î” Eâ‹†/Ï†/E | âŠ–â‹†-âœ“â€² =
      let open â‰…-Reasoning; Î“â€² = incâ‹† aâ‹† in
      begin
         Procâ†± (cong (_+_ Î“) (+-assoc Î”â€² 1 Î“â€²)) (target Ï†/E/Eâ‹†)
      â‰…âŸ¨ Procâ†² (cong (_+_ Î“) (+-assoc Î”â€² 1 Î“â€²)) _ âŸ©
         target Ï†/E/Eâ‹†
      â‰…âŸ¨ âŠ–â‹†-âœ“â€² âŸ©
         targetâ‹† Eâ‹†/Ï†/E
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + Î”â€²) 1 Î“â€²) _) âŸ©
         Procâ†± (+-assoc (Î“ + Î”â€²) 1 Î“â€²) (targetâ‹† Eâ‹†/Ï†/E)
      âˆ
   âŠ–â‹†-âœ“ {Î“} áµ›âˆ‡áµ› Î”â€² {aâ‹† = _ á´¬â‹†.á¶œâˆ· aâ‹†} (E á¶œâˆ· Eâ‹†) Ï† with âŠ– E Ï†
   ... | Ï†/E Î” E/Ï† with âŠ–â‹†[ áµ›âˆ‡áµ› , Î”â€² ] Eâ‹† Ï†/E | âŠ–â‹†-âœ“ áµ›âˆ‡áµ› Î”â€² Eâ‹† Ï†/E
   ... | Ï†/E/Eâ‹† Î” Eâ‹†/Ï†/E | âŠ–â‹†-âœ“â€² =
      let open â‰…-Reasoning; Î“â€² = incâ‹† aâ‹† in
      begin
         Procâ†± (cong (_+_ Î“) (+-assoc Î”â€² 0 Î“â€²)) (target Ï†/E/Eâ‹†)
      â‰…âŸ¨ Procâ†² (cong (_+_ Î“) (+-assoc Î”â€² 0 Î“â€²)) _ âŸ©
         target Ï†/E/Eâ‹†
      â‰…âŸ¨ âŠ–â‹†-âœ“â€² âŸ©
         targetâ‹† Eâ‹†/Ï†/E
      â‰…âŸ¨ â‰…-sym (Procâ†² (+-assoc (Î“ + Î”â€²) 0 Î“â€²) _) âŸ©
         Procâ†± (+-assoc (Î“ + Î”â€²) 0 Î“â€²) (targetâ‹† Eâ‹†/Ï†/E)
      âˆ
